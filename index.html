<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Acceso Seguro</title>

<link rel="manifest" href="manifest.json">
<link rel="apple-touch-icon" href="icons/icon-192.png">
<meta name="theme-color" content="#4f46e5">

<script src="https://cdn.tailwindcss.com"></script>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap"
      rel="stylesheet"/>
<link crossorigin="anonymous"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
      referrerpolicy="no-referrer"
      rel="stylesheet"/>

<style>
  /* ==== RESPONSIVE ==== */
  @media (max-width: 768px) {
    .note-card { flex-direction: column !important; align-items: flex-start !important; }
    .note-card .items-end { align-self: flex-end; margin-top: 1rem; }
    #pinScreen { padding: 2rem; }
    .main-search-container { padding: 1rem; }
  }
  body {font-family: 'Inter', sans-serif; background-color:#f8f9fa;}
  .main-search-container{min-height:calc(100vh - 200px);display:flex;align-items:center;justify-content:center;}
  .tag{
    background-color:#4f46e5;color:#fff;padding:.25rem .6rem;border-radius:9999px;
    font-size:.8rem;font-weight:500;display:inline-flex;align-items:center;gap:.25rem;
    transition:all .2s ease-in-out;background-image:linear-gradient(to right,#4f46e5,#8b5cf6);
  }
  .tag:hover{transform:scale(1.05);box-shadow:0 4px 6px -1px rgba(0,0,0,.1),0 2px 4px -2px rgba(0,0,0,.1);}
  .note-card{transition:transform .2s ease-in-out,box-shadow .2s ease-in-out;}
  .note-card:hover{transform:translateY(-5px);box-shadow:0 10px 15px -3px rgb(0 0 0 / .07),0 4px 6px -4px rgb(0 0 0 / .07);}
  .modal{display:none;opacity:0;transition:opacity .3s ease;}
  .modal.active{display:flex;opacity:1;}
  .modal-content{transform:scale(.95);transition:transform .3s ease;}
  .modal.active .modal-content{transform:scale(1);}
  input[type="file"]{display:none;}
  #toast-container{position:fixed;top:20px;right:20px;z-index:100;}
  .toast{
    display:flex;align-items:center;padding:1rem 1.5rem;border-radius:.5rem;
    box-shadow:0 4px 6px -1px rgba(0,0,0,.1),0 2px 4px -2px rgba(0,0,0,.1);
    opacity:0;transform:translateX(100%);transition:all .3s ease-in-out;
  }
  .toast.show{opacity:1;transform:translateX(0);}
  .toast.success{background-color:#d1fae5;color:#065f46;}
  .toast.error{background-color:#fee2e2;color:#991b1b;}
  .mobile-drawer{
    transition:transform .3s ease-in-out;
    transform:translateX(100%);
  }
  .mobile-drawer.active{
    transform:translateX(0);
  }
  .dropdown-menu{display:none;}
  .dropdown-menu.active{display:block;}
</style>
</head>

<body class="bg-gray-100 flex items-center justify-center h-screen">

<div class="hidden md:block fixed top-4 right-4 z-50">
  <button class="text-gray-700 bg-white p-2 rounded shadow-md hover:bg-gray-100"
          onclick="logoutApp()"><i class="fas fa-sign-out-alt"></i></button>
</div>

<div class="md:hidden fixed top-4 left-4 z-50">
  <button class="text-gray-700 bg-white p-2 rounded shadow-md"
          onclick="toggleMobileDrawer()"><i class="fas fa-bars fa-lg"></i></button>
</div>

<div id="mobileDrawer" class="fixed inset-y-0 left-0 w-64 bg-white shadow-lg p-6 z-50 mobile-drawer md:hidden">
  <div class="flex justify-between items-center mb-6">
    <h3 class="text-xl font-bold">Menú</h3>
    <button class="text-gray-700 text-2xl" onclick="toggleMobileDrawer()"><i class="fas fa-times"></i></button>
  </div>
  <div class="flex flex-col space-y-4">
    <button class="w-full text-left px-4 py-2 text-sm font-medium text-gray-700 bg-white border border-gray-300 rounded-md hover:bg-gray-100"
            id="mobileViewAllButton"><i class="fa-solid fa-list"></i> Ver Todo</button>
    <button class="w-full text-left px-4 py-2 text-sm font-medium text-gray-700 bg-white border border-gray-300 rounded-md hover:bg-gray-100"
            id="mobileMfcButton"><i class="fa-solid fa-download"></i> Recursos</button>
    <button class="w-full text-left px-4 py-2 text-sm font-medium text-white bg-gray-800 rounded-md hover:bg-gray-900"
            id="mobileAddItemButton"><i class="fa-solid fa-plus"></i> Añadir Item</button>
  </div>
</div>

<div id="loader" class="fixed inset-0 flex items-center justify-center bg-white z-50">
  <div class="text-center space-y-4">
    <svg class="animate-spin h-10 w-10 text-blue-600 mx-auto" fill="none"
         viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
      <circle class="opacity-25" cx="12" cy="12" r="10"
              stroke="currentColor" stroke-width="4"></circle>
      <path class="opacity-75" d="M4 12a8 8 0 018-8v8z"
            fill="currentColor"></path>
    </svg>
    <p class="text-gray-700 text-lg font-medium">Cargando…</p>
  </div>
</div>

<div id="pinScreen" class="text-center space-y-6">
  <h1 class="text-2xl font-bold">Introduce el PIN para acceder</h1>
  <input id="pinInput" maxlength="4" placeholder="PIN"
         type="password"
         class="px-4 py-2 border rounded text-center text-xl"/>
  <div>
    <button class="mt-4 bg-blue-600 text-white px-6 py-2 rounded hover:bg-blue-700"
            onclick="checkPIN()">Entrar</button>
  </div>
  <p id="errorMsg" class="text-red-500 font-medium hidden">PIN incorrecto</p>
</div>

<div id="appContent" style="display:none;">

  <header id="app-header"
          class="bg-white/80 backdrop-blur-lg sticky top-0 z-40 border-b border-gray-200 hidden">
    <div class="container mx-auto px-4 sm:px-6 lg:px-8">
      <div class="flex items-center justify-between h-16">
        <div class="flex items-center">
          <button id="logoButton"
                  class="flex items-center gap-2 text-xl font-bold text-gray-800">
            <span class="bg-gray-800 text-white rounded-md w-7 h-7 flex items-center justify-center">
              <i class="fa-solid fa-plus"></i>
            </span> Mikel
          </button>
        </div>
        <nav class="hidden md:flex items-center gap-3">
          <button id="viewAllButton"
                  class="flex items-center gap-2 px-4 py-2 text-sm font-medium text-gray-700 bg-white border border-gray-300 rounded-md hover:bg-gray-50">
            <i class="fa-solid fa-list"></i> Ver Todo
          </button>
          <button id="mfcButton"
                  class="flex items-center gap-2 px-4 py-2 text-sm font-medium text-gray-700 bg-white border border-gray-300 rounded-md hover:bg-gray-50">
            <i class="fa-solid fa-download"></i> Recursos
          </button>
          <button id="addItemButtonHeader"
                  class="flex items-center gap-2 px-4 py-2 text-sm font-medium text-white bg-gray-800 rounded-md hover:bg-gray-900">
            <i class="fa-solid fa-plus"></i> Añadir Item
          </button>
        </nav>
        <button id="menuToggleBtn"
                class="md:hidden text-gray-700 text-2xl"><i class="fas fa-bars"></i></button>
      </div>
    </div>
  </header>

  <main id="app-main"
        class="container mx-auto p-4 sm:p-6 lg:p-8 hidden">

    <div id="toast-container"></div>

    <section id="main-search-view">
      <div class="main-search-container">
        <div class="text-center w-full max-w-2xl">
          <div class="flex justify-center items-center gap-3 mb-6">
            <span class="bg-white border-2 border-gray-200 rounded-2xl w-16 h-16 flex items-center justify-center text-2xl"><i class="fa-solid fa-plus"></i></span>
          </div>
          <h1 class="text-5xl font-bold text-gray-800 mb-8">Mikel</h1>

          <div class="relative w-full shadow-lg rounded-full flex">
            <input id="mainSearchInput"
                   placeholder="Busca en tus notas o en la red..."
                   type="text"
                   class="flex-grow pl-6 pr-4 py-4 border border-gray-200 rounded-l-full focus:ring-2 focus:ring-blue-500 focus:border-blue-500"/>
            <button id="mainSearchButton"
                    class="px-6 bg-gray-800 text-white hover:bg-gray-900 transition-colors">Buscar</button>

            <div class="relative">
              <button id="webSearchDropdownBtn"
                      class="px-6 bg-blue-600 text-white rounded-r-full hover:bg-blue-700 transition-colors h-full flex items-center gap-2">
                Web <i class="fas fa-caret-down"></i>
              </button>

              <div id="webSearchDropdownMenu"
                   class="dropdown-menu absolute right-0 mt-2 py-2 w-48 bg-white rounded-md shadow-xl z-20">
                <a id="dropdown-copytech-btn"
                   href="#"
                   class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100"
                   data-type="copytech">Copytechnet</a>
                <a id="dropdown-printcopy-btn"
                   href="#"
                   class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100"
                   data-type="printcopy">Printcopy.info</a>
                <a id="dropdown-google-btn"
                   href="#"
                   class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100"
                   data-type="google">Google General</a>
              </div>
            </div>
          </div>
        </div>
      </div>
    </section>

    <section id="all-items-view" class="hidden">
      <div class="flex justify-between items-center mb-6">
        <h2 class="text-2xl font-bold">Base de Conocimiento</h2>
        <div class="relative w-full max-w-xs">
          <input id="searchInput"
                 type="text"
                 placeholder="Filtrar resultados..."
                 class="w-full pl-10 pr-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"/>
          <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
            <i class="fas fa-search text-gray-400"></i>
          </div>
        </div>
      </div>

      <div id="loading-indicator" class="text-center py-10">
        <i class="fas fa-spinner fa-spin fa-3x text-blue-500"></i>
        <p class="mt-2 text-gray-600">Cargando notas...</p>
      </div>

      <div id="no-notes-message"
           class="text-center py-10 bg-white rounded-lg shadow-sm hidden">
        <i class="fas fa-folder-open fa-3x text-gray-400"></i>
        <p class="mt-4 text-xl font-semibold text-gray-700">No hay items todavía.</p>
        <p class="text-gray-500">Usa el botón "Añadir Item" para empezar.</p>
      </div>

      <div id="no-results-message"
           class="text-center py-10 bg-white rounded-lg shadow-sm hidden">
        <i class="fas fa-search-minus fa-3x text-gray-400"></i>
        <p class="mt-4 text-xl font-semibold text-gray-700">No se encontraron resultados.</p>
        <p class="text-gray-500">Prueba con otros términos de búsqueda.</p>
      </div>

      <div id="notes-container"
           class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6"></div>
    </section>

  </main>
</div>

<div id="addNoteModal"
     class="modal fixed inset-0 bg-gray-900 bg-opacity-75 items-center justify-center p-4 overflow-y-auto">
  <div class="modal-content bg-white rounded-xl shadow-2xl w-full max-w-2xl">
    <div class="flex justify-between items-center p-5 border-b border-gray-200">
      <h3 id="modalTitle" class="text-2xl font-bold text-gray-800">Añadir Nuevo Item</h3>
      <button class="modal-close text-gray-400 hover:text-gray-600"
              data-modal="addNoteModal"><i class="fas fa-times fa-2x"></i></button>
    </div>

    <form id="addNoteForm" onsubmit="return false;">
      <input id="noteIdToEdit" type="hidden"/>
      <div class="p-6 space-y-4">

        <div>
          <label for="noteTitle"
                 class="block text-sm font-medium text-gray-700 mb-1">Título</label>
          <input id="noteTitle"
                 type="text"
                 class="w-full border border-gray-300 rounded-lg p-2 focus:ring-2 focus:ring-blue-500"/>
        </div>

        <div>
          <label for="noteContent"
                 class="block text-sm font-medium text-gray-700 mb-1">Contenido</label>
          <textarea id="noteContent"
                    rows="8"
                    class="w-full border border-gray-300 rounded-lg p-2 focus:ring-2 focus:ring-blue-500"></textarea>
        </div>

        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1">Adjuntos</label>
          <input id="noteAttachment"
                 type="file"
                 multiple/>
          <label for="noteAttachment"
                 id="noteAttachmentLabel"
                 class="w-full cursor-pointer bg-white border border-gray-300 rounded-lg p-2 flex items-center justify-center gap-2 hover:bg-gray-50">
            <i class="fas fa-upload"></i><span>Seleccionar archivos</span>
          </label>

          <div id="selected-files-container"
               class="w-full bg-gray-100 border border-gray-200 rounded-lg p-2 mt-2">
            <div id="file-chosen-list" class="space-y-1"></div>
            <p id="no-files-selected-message"
               class="text-sm text-gray-500 text-center py-2">
              No hay archivos seleccionados.
            </p>
          </div>
        </div>

      </div>
    </form>

    <div class="bg-gray-50 p-5 flex justify-end rounded-b-xl">
      <button id="saveNoteButton"
              class="bg-gray-800 text-white font-bold py-2 px-6 rounded-lg hover:bg-gray-900 transition-colors flex items-center gap-2">
        Guardar Item
      </button>
    </div>
  </div>
</div>

<div id="mfcModal"
     class="modal fixed inset-0 bg-gray-900 bg-opacity-75 items-center justify-center p-4 overflow-y-auto">
  <div class="modal-content bg-white rounded-xl shadow-2xl w-full max-w-lg">
    <div class="flex justify-between items-center p-5 border-b border-gray-200">
      <h3 class="text-2xl font-bold text-gray-800">Recursos</h3>
      <button class="modal-close text-gray-400 hover:text-gray-600"
              data-modal="mfcModal"><i class="fas fa-times fa-2x"></i></button>
    </div>

    <div class="p-6">
      <ul class="space-y-4">
        <li><a class="flex items-center gap-3 text-blue-600 hover:text-blue-800 hover:underline"
               href="https://firebasestorage.googleapis.com/v0/b/mikelaneako.firebasestorage.app/o/MFC.msi?alt=media&token=0daacbfb-75a9-4d94-87c4-ac366f8b31f7"
               download><i class="fas fa-file-archive fa-fw text-lg"></i><span class="font-medium">MFC.msi</span></a></li>
        <li><a class="flex items-center gap-3 text-blue-600 hover:text-blue-800 hover:underline"
               href="https://firebasestorage.googleapis.com/v0/b/mikelaneako.firebasestorage.app/o/mfc.exe?alt=media&token=4e8a9bd2-6c55-4a54-a316-b7bad9839113"
               download><i class="fas fa-file-code fa-fw text-lg"></i><span class="font-medium">mfc.exe</span></a></li>
        <li><a class="flex items-center gap-3 text-green-600 hover:text-green-800 hover:underline"
               href="https://mfc.maquelsa.com/mfc3/access.php"
               target="_blank" rel="noopener noreferrer"><i class="fas fa-external-link-alt fa-fw text-lg"></i><span class="font-medium">Acceso Web 1 (Maquelsa)</span></a></li>
        <li><a class="flex items-center gap-3 text-green-600 hover:text-green-800 hover:underline"
               href="https://mirror1.infodesain.com/nodeprint/access.php"
               target="_blank" rel="noopener noreferrer"><i class="fas fa-external-link-alt fa-fw text-lg"></i><span class="font-medium">Acceso Web 2 (Mirrorspan></a></li>
      </ul>

      <p class="mt-6 text-sm text-yellow-700 bg-yellow-100 p-3 rounded-md">
        <i class="fas fa-exclamation-triangle mr-2"></i>
        <strong>Importante:</strong> Los ficheros descargables son de ejemplo. Debes actualizarlos con tus propias URLs.
      </p>
    </div>
  </div>
</div>

<div id="confirmationModal"
     class="modal fixed inset-0 bg-gray-900 bg-opacity-75 items-center justify-center p-4">
  <div class="modal-content bg-white rounded-xl shadow-2xl w-full max-w-md">
    <div class="p-6 text-center">
      <i class="fas fa-exclamation-triangle fa-3x text-yellow-400 mb-4"></i>
      <h3 class="text-xl font-bold text-gray-800">Confirmación Requerida</h3>
      <p id="confirmationMessage" class="text-gray- my-4">¿Estás seguro?</p>
    </div>
    <div class="bg-gray-50 p-4 flex justify-center gap-4 rounded-b-xl">
      <button id="cancelButton"
              class="px-6 py-2 text-sm font-medium text-gray-700 bg-white border border-gray-300 rounded-md hover:bg-gray-50">
        Cancelar
      </button>
      <button id="confirmButton"
              class="px-6 py-2 text-sm font-medium text-white bg-red-600 rounded-md hover:bg-red-700">
        Confirmar
      </button>
    </div>
  </div>
</div>

<script>
  /* --------------------------------------------------------------
   * PIN
   * -------------------------------------------------------------- */
  function checkPIN() {
    const pin = document.getElementById('pinInput').value;
    if (pin === '2548') {
      document.getElementById('pinScreen').style.display = 'none';
      document.getElementById('appContent').style.display = 'block';
    } else {
      document.getElementById('errorMsg').classList.remove('hidden');
    }
  }

  /* --------------------------------------------------------------
   * CARGADOR
   * -------------------------------------------------------------- */
  window.addEventListener('load', () => {
    document.getElementById('loader').style.display = 'none';
  });

  /* --------------------------------------------------------------
   * LOGOUT
   * -------------------------------------------------------------- */
  function logoutApp() {
    document.getElementById('appContent').style.display = 'none';
    document.getElementById('pinScreen').style.display = 'block';
    document.getElementById('pinInput').value = '';
    document.getElementById('errorMsg').classList.add('hidden');
  }

  /* --------------------------------------------------------------
   * MOBILE DRAWER
   * -------------------------------------------------------------- */
  function toggleMobileDrawer() {
    document.getElementById('mobileDrawer').classList.toggle('active');
  }

  /* --------------------------------------------------------------
   * FIREBASE
   * -------------------------------------------------------------- */
  //--- Configuración (usa tus propios datos) ---------------------------------
  const firebaseConfig = {
    apiKey: "AIzaSyA26sad8msWrNTVByMs8umSUV_OJsqctuE",
    authDomain: "mikelaneako.firebaseapp.com",
    projectId: "mikelaneako",
    storageBucket: "mikelaneako.firebasestorage.app",
    messagingSenderId: "261413636045",
    appId: "1:261413636045:web:717b7e87d84a345e816684"
  };
  firebase.initializeApp(firebaseConfig);
  const db = firebase.firestore();
  const storage = firebase.storage();
  const auth = firebase.auth();

  let allNotes = [];
  let DOM = {};
  // Archivos seleccionados (nuevo / existentes)
  let currentSelectedFiles = [];

  /* --------------------------------------------------------------
   * INICIALIZACIÓN
   * -------------------------------------------------------------- */
  window.onload = () => {
    initDOM();
    bindEvents();

    auth.signInAnonymously()
        .then(() => {
          DOM.appHeader.classList.remove('hidden');
          DOM.appMain.classList.remove('hidden');
          showView('search');
          loadNotes();
        })
        .catch(err => {
          console.error('Auth error', err);
          showToast('Error de autenticación.', 'error');
          DOM.appHeader.classList.remove('hidden');
          DOMMain.classList.remove('hidden');
          showView('search');
        });
  };

  function initDOM() {
    DOM = {
      appHeader:           document.getElementById('app-header'),
      appMain:             document.getElementById('app-main'),
      mainSearchView:      document.getElementById('main-search-view'),
      allItemsView:        document.getElementById('all-items-view'),
      notesContainer:      document.getElementById('notes-container'),
      searchInput:         document.getElementById('searchInput'),
      mainSearchInput:     document.getElementById('mainSearchInput'),
      mainSearchButton:    document.getElementById('mainSearchButton'),
      loadingIndicator:    document.getElementById('loading-indicator'),
      noNotesMessage:      document.getElementById('no-notes-message'),
      noResultsMessage:    document.getElementById('no-results-message'),
      logoButton:          document.getElementById('logoButton'),
      viewAllButton:       document.getElementById('viewAllButton'),
      mfcButton:           document.getElementById('mfcButton'),
      mfcModal:            document.getElementById('mfcModal'),
      addItemButtonHeader: document.getElementById('addItemButtonHeader'),
      addNoteModal:        document.getElementById('addNoteModal'),
      addNoteForm:         document.getElementById('addNoteForm'),
      modalTitle:          document.getElementById('modalTitle'),
      noteIdToEdit:        document.getElementById('noteIdToEdit'),
      noteTitleInput:      document.getElementById('noteTitle'),
      noteContentInput:    document.getElementById('noteContent'),
      noteAttachmentInput: document.getElementById('noteAttachment'),
      noteAttachmentLabel: document.getElementById('noteAttachmentLabel'),
      selectedFilesContainer: document.getElementById('selected-files-container'),
      fileChosenList:      document.getElementById('file-chosen-list'),
      noFilesSelectedMessage: document.getElementById('no-files-selected-message'),
      saveNoteButton:      document.getElementById('saveNoteButton'),
      confirmationModal:   document.getElementById('confirmationModal'),
      confirmationMessage: document.getElementById('confirmationMessage'),
      confirmButton:       document.getElementById('confirmButton'),
      cancelButton:        document.getElementById('cancelButton'),
      toastContainer:      document.getElementById('toast-container'),
      webSearchDropdownBtn: document.getElementById('webSearchDropdownBtn'),
      webSearchDropdownMenu: document.getElementById('webSearchDropdownMenu'),
      menuToggleBtn:       document.getElementById('menuToggleBtn'),
      mobileDrawer:        document.getElementById('mobileDrawer'),
      mobileViewAllButton: document.getElementById('mobileViewAllButton'),
      mobileAddItemButton: document.getElementById('mobileAddItemButton'),
      mobileMfcButton:     document.getElementById('mobileMfcButton')
    };
  }

  function bindEvents() {
    // Header
    DOM.logoButton.addEventListener('click', () => showView('search'));
    DOM.viewAllButton.addEventListener('click', () => {
      DOM.searchInput.value = '';
      renderNotes(allNotes);
      showView('items');
    });
    DOM.mfcButton.addEventListener('click', () => toggleModal('mfcModal', true));
    DOM.addItemButtonHeader.addEventListener('click', openAddModal);

    // Mobile drawer
    DOM.menuToggleBtn.addEventListener('click', () => toggleMobileDrawer());
    DOM.mobileViewAllButton.addEventListener('click', () => {
      DOM.searchInput.value = '';
      renderNotes(allNotes);
      showView('items');
      toggleMobileDrawer();
    });
    DOM.mobileAddItemButton.addEventListener('click', () => {
      openAddModal();
      toggleMobileDrawer();
    });
    DOM.mobileMfcButton.addEventListener('click', () => {
      toggleModal('mfcModal', true);
      toggleMobileDrawer();
    });

    // Search
    DOM.mainSearchButton.addEventListener('click', () => performSearch(DOM.mainSearchInput.value, 'db'));
    DOM.mainSearchInput.addEventListener('keypress', e => {
      if (e.key === 'Enter') performSearch(DOM.mainSearchInput.value, 'db');
    });
    DOM.searchInput.addEventListener('input', () => filterNotes(DOM.searchInput.value));

    // Modals
    document.querySelectorAll('.modal-close')
            .forEach(btn => btn.addEventListener('click', () => toggleModal(btn.dataset.modal, false)));
    DOM.saveNoteButton.addEventListener('click', saveNote);
    DOM.noteAttachmentInput.addEventListener('change', handleFileSelect);
    DOM.cancelButton.addEventListener('click', () => toggleModal('confirmationModal', false));

    // Dropdown web search
    DOM.webSearchDropdownBtn.addEventListener('click', e => {
      e.stopPropagation();
      DOM.webSearchDropdownMenu.classList.toggle('active');
    });
    document.addEventListener('click', e => {
      if (!DOM.webSearchDropdownBtn.contains(e.target) && !DOM.webSearchDropdownMenu.contains(e.target))
        DOM.webSearchDropdownMenu.classList.remove('active');
    });
    document.getElementById('dropdown-copytech-btn')
            .addEventListener('click', () => {
              performSearch(DOM.mainSearchInput.value, 'copytech');
              DOM.webSearchDropdownMenu.classList.remove('active');
            });
    document.getElementById('dropdown-printcopy-btn')
            .addEventListener('click', () => {
              performSearch(DOM.mainSearchInput.value, 'printcopy');
              DOM.webSearchDropdownMenu.classList.remove('active');
            });
    document.getElementById('dropdown-google-btn')
            .addEventListener('click', () => {
              performSearch(DOM.mainSearchInput.value, 'google');
              DOM.webSearchDropdownMenu.classList.remove('active');
            });
  }

  /* --------------------------------------------------------------
   * VISTAS
   * -------------------------------------------------------------- */
  function showView(name) {
    DOM.mainSearchView.classList.toggle('hidden', name !== 'search');
    DOM.allItemsView.classList.toggle('hidden', name !== 'items');
  }

  /* --------------------------------------------------------------
   * BÚSQUEDA
   * -------------------------------------------------------------- */
  function performSearch(term, type) {
    if (!term) return showToast('Introduce un término de búsqueda.', 'error');

    if (type === 'db') {
      filterNotes(term);
      showView('items');
    } else {
      const urlMap = {
        copytech: `https://www.google.com/search?q=${encodeURIComponent(term)}+site:copytechnet.com`,
        printcopy:`https://www.google.com/search?q=${encodeURIComponent(term)}+site:printcopy.info`,
        google:   `https://www.google.com/search?q=${encodeURIComponent(term)}`
      };
      window.location.href = urlMap[type];
    }
  }

  function filterNotes(term) {
    const lower = term.toLowerCase();
    DOM.searchInput.value = lower;
    DOM.mainSearchInput.value = lower;
    const filtered = allNotes.filter(n =>
      n.titulo.toLowerCase().includes(lower) ||
      n.descripcion.toLowerCase().includes(lower) ||
      (n.attachments && n.attachments.some(a => a.name.toLowerCase().includes(lower)))
    );
    renderNotes(filtered);
  }

  /* --------------------------------------------------------------
   * CRUD FIREBASE
   * -------------------------------------------------------------- */
  function loadNotes() {
    DOM.loadingIndicator.classList.remove('hidden');
    db.collection('notas')
      .orderBy('fecha', 'desc')
      .onSnapshot(snapshot => {
        allNotes = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
        renderNotes(allNotes);
        DOM.loadingIndicator.classList.add('hidden');
      }, err => {
        console.error('Load notes error', err);
        showToast('Error al cargar notas.', 'error');
        DOM.loadingIndicator.classList.add('hidden');
      });
  }

  async function saveNote() {
    const title   = DOM.noteTitleInput.value.trim();
    const content = DOM.noteContentInput.value.trim();
    const noteId  = DOM.noteIdToEdit.value;

    if (!title || !content) return showToast('Título y contenido obligatorios.', 'error');

    DOM.saveNoteButton.disabled = true;
    DOM.saveNoteButton.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Guardando...';

    try {
      let finalAttachments = [];

      // ---------- EDIT ----------
      if (noteId) {
        const existing = allNotes.find(n => n.id === noteId);
        const existingAtt = existing.attachments || [];

        // Archivos que se eliminarán del storage
        const toDelete = existingAtt.filter(ea =>
          !currentSelectedFiles.some(sf => sf.name === ea.name && sf.isExisting)
        );
        for (const del of toDelete) {
          if (del.path) await storage.ref(del.path).delete().catch(() => {});
        }

        // Nuevos archivos a subir
        const newFiles = currentSelectedFiles.filter(f => !f.isExisting);
        const uploaded = await uploadFiles(newFiles);

        // Mantener los que siguen seleccionados y son existentes
        const unchanged = currentSelectedFiles.filter(f => f.isExisting);
        finalAttachments = [...unchanged, ...uploaded];
      }
      // ---------- CREATE ----------
      else if (currentSelectedFiles.length) {
        finalAttachments = await uploadFiles(currentSelectedFiles);
      }

      const noteData = {
        titulo: title,
        descripcion: content,
        attachments: finalAttachments,
        fecha: firebase.firestore.Timestamp.fromDate(new Date())
      };

      if (noteId) {
        await db.collection('notas').doc(noteId).update(noteData);
        showToast('Item actualizado.', 'success');
      } else {
        await db.collection('notas').add(noteData);
        showToast('Item añadido.', 'success');
      }

      toggleModal('addNoteModal', false);
    } catch (e) {
      console.error(e);
      showToast('Error al guardar la nota.', 'error');
    } finally {
      DOM.saveNoteButton.disabled = false;
      DOM.saveNoteButton.innerHTML = 'Guardar Item';
    }
  }

  async function uploadFiles(files) {
    const promises = files.map(async f => {
      const ref = storage.ref('adjuntos/' + Date.now() + '-' + f.name);
      await ref.put(f);
      const url = await ref.getDownloadURL();
      return { url, path: ref.fullPath, name: f.name };
    });
    return Promise.all(promises);
  }

  function confirmDelete(noteId) {
    showConfirmation('¿Seguro que quieres eliminar esta nota? No se puede deshacer.',
      () => deleteNote(noteId));
  }

  async function deleteNote(noteId) {
    try {
      const doc = await db.collection('notas').doc(noteId).get();
      if (doc.exists) {
        const data = doc.data();
        if (data.attachments) {
          for (const att of data.attachments) {
            if (att.path) await storage.ref(att.path).delete().catch(() => {});
          }
        }
        await db.collection('notas').doc(noteId).delete();
        showToast('Nota eliminada.', 'success');
      }
    } catch (e) {
      console.error(e);
      showToast('Error al eliminar la nota.', 'error');
    }
  }

  /* --------------------------------------------------------------
   * MODALS & UI
   * -------------------------------------------------------------- */
  function toggleModal(id, show) {
    const m = document.getElementById(id);
    if (show) m.classList.add('active');
    else {
      m.classList.remove('active');
      if (id === 'addNoteModal') resetAddForm();
    }
  }

  function openAddModal() {
    resetAddForm();
    DOM.modalTitle.textContent = 'Añadir Nuevo Item';
    toggleModal('addNoteModal', true);
  }

  function openEditModal(note) {
    resetAddForm();
    DOM.modalTitle.textContent = 'Editar Item';
    DOM.noteIdToEdit.value = note.id;
    DOM.noteTitleInput.value = note.titulo;
    DOM.noteContentInput.value = note.descripcion;

    if (note.attachments && note.attachments.length) {
      currentSelectedFiles = note.attachments.map(att => ({
        name: att.name,
        url: att.url,
        path: att.path,
        isExisting: true
      }));
      renderSelectedFiles();
    } else clearSelectedFiles();

    toggleModal('addNoteModal', true);
  }

  function resetAddForm() {
    DOM.addNoteForm.reset();
    DOM.noteIdToEdit.value = '';
    clearSelectedFiles();
  }

  /* --------- FILES (adjuntos) --------- */
  function handleFileSelect(e) {
    const newFiles = Array.from(e.target.files);
    const uniq = newFiles.filter(f =>
      !currentSelectedFiles.some(s => s.name === f.name && s.size === f.size)
    );
    currentSelectedFiles = [...currentSelectedFiles, ...uniq];
    renderSelectedFiles();
    e.target.value = ''; // permitir volver a seleccionar los mismos archivos
  }

  function renderSelectedFiles() {
    DOM.fileChosenList.innerHTML = '';
    if (currentSelectedFiles.length) {
      DOM.noFilesSelectedMessage.classList.add('hidden');
      currentSelectedFiles.forEach((f, i) => {
        const div = document.createElement('div');
        div.className = 'flex items-center justify-between bg-white border border-gray-200 rounded-md p-2 text-sm text-gray-700';
        div.innerHTML = `
          <span>${escapeHTML(f.name)}</span>
          <button type="button" class="text-red-500 hover:text-red-700 ml-2" data-index="${i}">
            <i class="fas fa-times"></i>
          </button>`;
        DOM.fileChosenList.appendChild(div);
      });
      // listeners de borrado individual
      DOM.fileChosenList.querySelectorAll('button')
          .forEach(btn => btn.addEventListener('click', e => {
            const idx = parseInt(e.currentTarget.dataset.index);
            currentSelectedFiles.splice(idx, 1);
            renderSelectedFiles();
          }));
    } else {
      DOM.noFilesSelectedMessage.classList.remove('hidden');
    }
  }

  function clearSelectedFiles() {
    DOM.noteAttachmentInput.value = '';
    currentSelectedFiles = [];
    renderSelectedFiles();
  }

  /* --------------------------------------------------------------
   * RENDER NOTAS
   * -------------------------------------------------------------- */
  function renderNotes(notes) {
    DOM.notesContainer.innerHTML = '';
    DOM.noResultsMessage.classList.toggle('hidden',
      notes.length === 0 && DOM.searchInput.value !== '');
    DOM.noNotesMessage.classList.toggle('hidden',
      notes.length > 0);

    notes.forEach(note => {
      const card = document.createElement('div');
      card.className = 'note-card bg-white p-6 rounded-xl shadow-sm border border-gray-200 flex flex-col';

      const attachHTML = (note.attachments && note.attachments.length)
        ? note.attachments.map(a => `
            <a href="${a.url}" target="_blank" rel="noopener noreferrer"
               class="inline-flex items-center gap-2 text-sm text-blue-600 hover:underline mt-1">
              <i class="fas fa-paperclip"></i><span>${escapeHTML(a.name || 'Adjunto')}</span>
            </a>`).join('<br>')
        : '';

      const date = note.fecha ? new Date(note.fecha.seconds * 1000).toLocaleString() : 'N/A';

      card.innerHTML = `
        <div class="flex-grow">
          <div class="flex justify-between items-start mb-2">
            <h3 class="text-xl font-bold text-gray-900 pr-4">${escapeHTML(note.titulo)}</h3>
            <p class="text-gray-600 whitespace-pre-wrap mb-4">${escapeHTML(note.descripcion)}</p>
            <div class="flex items-center gap-3">
              <button data-id="${note.id}" class="edit-note-btn text-gray-400 hover:text-blue-500"><i class="fas fa-pencil-alt"></i></button>
              <button data-id="${note.id}" class="delete-note-btn text-gray-400 hover:text-red-500"><i class="fas fa-trash-alt"></i></button>
            </div>
          </div>
        </div>
        <div>
          ${attachHTML}
          <div class="text-right text-xs text-gray-400 mt-4">${date}</div>
        </div>`;

      DOM.notesContainer.appendChild(card);
    });

    // botones edit / delete
    document.querySelectorAll('.edit-note-btn')
            .forEach(b => b.addEventListener('click', e => {
              e.stopPropagation();
              const note = allNotes.find(n => n.id === e.currentTarget.dataset.id);
              if (note) openEditModal(note);
            }));
    document.querySelectorAll('.delete-note-btn')
            .forEach(b => b.addEventListener('click', e => {
              e.stopPropagation();
              confirmDelete(e.currentTarget.dataset.id);
            }));
  }

  /* --------------------------------------------------------------
   * TOAST & CONFIRM
   * -------------------------------------------------------------- */
  function showToast(msg, type = 'success') {
    const t = document.createElement('div');
    t.className = `toast ${type}`;
    t.innerHTML = `<i class="fas ${type === 'success' ? 'fa-check-circle' : 'fa-exclamation-triangle'} mr-3"></i>${msg}`;
    DOM.toastContainer.appendChild(t);
    setTimeout(() => t.classList.add('show'), 10);
    setTimeout(() => {
      t.classList.remove('show');
      t.addEventListener('transitionend', () => t.remove());
    }, 4000);
  }

  function showConfirmation(msg, onConfirm) {
    DOM.confirmationMessage.textContent = msg;

    // limpiar listeners previos
    const newBtn = DOM.confirmButton.cloneNode(true);
    DOM.confirmButton.parentNode.replaceChild(newBtn, DOM.confirmButton);
    DOM.confirmButton = newBtn;
    DOM.confirmButton.onclick = () => {
      toggleModal('confirmationModal', false);
      onConfirm();
    };
    toggleModal('confirmationModal', true);
  }

  /* --------------------------------------------------------------
   * UTILIDADES
   * -------------------------------------------------------------- */
  function escapeHTML(str) {
    const d = document.createElement('div');
    d.appendChild(document.createTextNode(str));
    return d.innerHTML;
  }
</script>

<script>
  if ('serviceWorker' in navigator) {
    window.addEventListener('load', () => {
      navigator.serviceWorker.register('sw.js')
        .then(reg => console.log('SW registrado', reg))
        .catch(err => console.warn('SW registro falló', err));
    });
  }
</script>
</body>
</html>