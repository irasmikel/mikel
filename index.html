<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Mi Control del Hogar">
    <title>Mi Control del Hogar</title>
    <!-- Incluye Tailwind CSS para un estilo rápido y responsivo -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" rel="stylesheet">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary-color: #4f46e5;
            --primary-hover: #4338ca;
            --success-color: #22c55e;
            --warning-color: #f59e0b;
            --danger-color: #ef4444;
            --gray-light: #f3f4f6;
            --gray-medium: #d1d5db;
            --gray-dark: #4b5563;
        }

        * {
            -webkit-tap-highlight-color: transparent;
            -webkit-touch-callout: none;
            -webkit-user-select: none;
            user-select: none;
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0f2f5;
            color: #333;
            overflow-x: hidden;
            touch-action: pan-y pinch-zoom;
        }

        /* Mejoras para la barra de navegación en móvil */
        header {
            padding: 8px 4px;
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
            scrollbar-width: none; /* Firefox */
        }

        header::-webkit-scrollbar {
            display: none; /* Chrome, Safari, Opera */
        }

        nav {
            display: flex;
            justify-content: space-between;
            min-width: max-content;
        }

        .nav-item {
            min-width: 70px;
            padding: 8px 4px;
            transition: all 0.2s ease;
        }

        .nav-icon {
            color: #6b7280;
            transition: color 0.2s;
            font-size: 1.5rem;
        }

        .nav-icon.active {
            color: var(--primary-color);
        }

        /* Mejoras para tarjetas */
        .task-card, .note-card {
            background-color: white;
            border-radius: 1rem;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
            transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
            cursor: pointer;
            border-left: 6px solid;
            padding: 16px;
            margin-bottom: 12px;
        }

        .task-card:hover, .note-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 16px rgba(0, 0, 0, 0.12);
        }

        /* Colores de borde para categorías de tareas */
        .category-baño { border-left-color: #4dc0b5; }
        .category-suelo { border-left-color: #9f7aea; }
        .category-cocina { border-left-color: #f6ad55; }
        .category-dormitorio { border-left-color: #3b82f6; }
        .category-general { border-left-color: #ef4444; }
        .category-pasillo { border-left-color: #6b7280; }
        .category-balcón { border-left-color: #10b981; }
        .category-otro { border-left-color: #a855f7; }

        /* Colores de borde para tipos de notas */
        .note-type-text { border-left-color: #2563eb; }
        .note-type-recipe { border-left-color: #9333ea; }
        .note-type-file { border-left-color: #d97706; }

        .completed-task {
            text-decoration: line-through;
            opacity: 0.6;
            background-color: #e2e8f0;
        }

        /* Botones optimizados para táctil */
        .add-task-btn, .add-note-btn {
            background: linear-gradient(to right, #6366f1, #8b5cf6);
            box-shadow: 0 4px 14px rgba(99, 102, 241, 0.3);
            transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
            position: fixed;
            bottom: 80px;
            right: 16px;
            z-index: 50;
            width: 60px;
            height: 60px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .add-task-btn:hover, .add-note-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(99, 102, 241, 0.4);
        }

        /* Botones de acción más grandes */
        .action-btn {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 4px;
            font-size: 1rem;
        }

        .complete-btn {
            background-color: var(--success-color);
        }

        .postpone-btn {
            background-color: var(--warning-color);
        }

        .edit-btn {
            background-color: #3b82f6;
        }

        .delete-btn {
            background-color: var(--danger-color);
        }

        /* Modales optimizados para móvil */
        .modal {
            background-color: rgba(0, 0, 0, 0.7);
            z-index: 1000;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 10px;
        }

        .modal-content {
            background-color: white;
            border-radius: 1rem;
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.2);
            width: 100%;
            max-width: 500px;
            max-height: 90vh;
            overflow-y: auto;
            padding: 20px;
        }

        /* Formularios optimizados */
        input, select, textarea {
            border: 1px solid var(--gray-medium);
            border-radius: 0.75rem;
            padding: 12px 16px;
            font-size: 1rem;
            width: 100%;
            box-sizing: border-box;
            margin-bottom: 12px;
        }

        button {
            border-radius: 0.75rem;
            padding: 12px 20px;
            font-weight: 600;
            font-size: 1rem;
            min-height: 44px;
        }

        /* Estilos para el campo de entrada de archivo */
        input[type="file"] {
            border: 1px solid var(--gray-medium);
            border-radius: 0.75rem;
            padding: 12px 16px;
            background-color: #f9fafb;
            cursor: pointer;
            margin-bottom: 8px;
        }

        input[type="file"]::file-selector-button {
            background-color: var(--primary-color);
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 0.5rem;
            cursor: pointer;
            margin-right: 1rem;
            transition: background-color 0.2s ease-in-out;
        }

        input[type="file"]::file-selector-button:hover {
            background-color: var(--primary-hover);
        }

        /* Mensajes de aplicación */
        #appMessage {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            padding: 12px 20px;
            border-radius: 0.75rem;
            color: white;
            font-weight: 600;
            z-index: 1001;
            opacity: 0;
            transition: opacity 0.3s ease-in-out, transform 0.3s ease-in-out;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            max-width: 90%;
            text-align: center;
        }

        #appMessage.show {
            opacity: 1;
            transform: translateX(-50%) translateY(0);
        }

        #appMessage.error {
            background-color: var(--danger-color);
        }

        #appMessage.success {
            background-color: var(--success-color);
        }

        /* Calendar specific styles */
        #calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 2px;
            background-color: #e2e8f0;
            border-radius: 0.75rem;
            overflow: hidden;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
        }

        .calendar-header-day {
            background-color: #cbd5e0;
            font-weight: 600;
            padding: 8px 4px;
            text-align: center;
            font-size: 0.8rem;
        }

        .calendar-day-cell {
            background-color: white;
            padding: 8px;
            min-height: 60px;
            display: flex;
            flex-direction: column;
            align-items: flex-start;
            justify-content: flex-start;
            font-size: 0.8rem;
            cursor: pointer;
            transition: background-color 0.2s ease-in-out;
            position: relative;
        }

        @media (max-width: 640px) {
            .calendar-day-cell {
                min-height: 50px;
                font-size: 0.75rem;
            }
        }

        .calendar-day-cell:hover {
            background-color: #f0f4f8;
        }

        .calendar-day-cell.inactive {
            background-color: #f8fafc;
            color: #cbd5e0;
            cursor: default;
        }

        .calendar-day-cell.today {
            border: 2px solid var(--primary-color);
            box-shadow: 0 0 0 1px var(--primary-color);
        }

        .calendar-day-cell .day-number {
            font-weight: 700;
            font-size: 0.9rem;
            margin-bottom: 4px;
        }

        .calendar-day-cell .task-indicator {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background-color: #f6ad55;
            margin-top: 4px;
            position: absolute;
            top: 8px;
            right: 8px;
        }

        .calendar-day-cell .task-count {
            font-size: 0.7rem;
            background-color: var(--success-color);
            color: white;
            border-radius: 9999px;
            padding: 2px 6px;
            position: absolute;
            bottom: 8px;
            right: 8px;
            font-weight: 600;
        }

        /* Modal for day tasks */
        #dayTasksModalContent ul {
            list-style: none;
            padding: 0;
        }

        #dayTasksModalContent ul li {
            padding: 8px 0;
            border-bottom: 1px solid #eee;
            font-size: 0.9rem;
        }

        #dayTasksModalContent ul li:last-child {
            border-bottom: none;
        }

        #dayTasksModalContent ul li .task-due {
            font-size: 0.8rem;
            color: var(--gray-dark);
        }

        /* Progress Bar */
        .progress-bar-container {
            width: 100%;
            background-color: #e5e7eb;
            border-radius: 9999px;
            height: 2rem;
            overflow: hidden;
            box-shadow: inset 0 1px 3px rgba(0,0,0,0.1);
        }

        .progress-bar-fill {
            height: 100%;
            background-color: var(--success-color);
            border-radius: 9999px;
            transition: width 0.5s ease-in-out;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 600;
            font-size: 0.9rem;
        }

        /* Indicador de carga */
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid var(--primary-color);
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Animaciones para transiciones suaves */
        .fade-in {
            animation: fadeIn 0.3s ease-in-out;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Indicador de deslizamiento */
        .swipe-indicator {
            position: fixed;
            bottom: 10px;
            left: 50%;
            transform: translateX(-50%);
            background-color: rgba(0, 0, 0, 0.6);
            color: white;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 0.8rem;
            z-index: 100;
            opacity: 0;
            transition: opacity 0.3s;
        }

        .swipe-indicator.show {
            opacity: 1;
        }
    </style>
</head>
<body class="min-h-screen flex flex-col">

    <!-- Header (Pestañas de Navegación) -->
    <header class="bg-white shadow-sm p-2 flex justify-around items-center sticky top-0 z-10">
        <nav class="flex space-x-2">
            <button class="nav-item flex flex-col items-center text-sm font-medium text-gray-700 hover:text-indigo-600 active-nav-tab" data-tab="today" aria-label="Tareas de hoy" aria-current="page">
                <i class="fas fa-home text-2xl nav-icon active" aria-hidden="true"></i>
                <span>Hoy</span>
            </button>
            <button class="nav-item flex flex-col items-center text-sm font-medium text-gray-700 hover:text-indigo-600" data-tab="pending" aria-label="Tareas pendientes">
                <i class="fas fa-clipboard-list text-2xl nav-icon" aria-hidden="true"></i>
                <span>Pendientes</span>
            </button>
            <button class="nav-item flex flex-col items-center text-sm font-medium text-gray-700 hover:text-indigo-600" data-tab="calendar" aria-label="Calendario de tareas">
                <i class="fas fa-calendar-alt text-2xl nav-icon" aria-hidden="true"></i>
                <span>Calendario</span>
            </button>
            <button class="nav-item flex flex-col items-center text-sm font-medium text-gray-700 hover:text-indigo-600" data-tab="notes" aria-label="Mis notas">
                <i class="fas fa-book text-2xl nav-icon" aria-hidden="true"></i>
                <span>Notas</span>
            </button>
            <button class="nav-item flex flex-col items-center text-sm font-medium text-gray-700 hover:text-indigo-600" data-tab="progress" aria-label="Mi progreso">
                <i class="fas fa-chart-line text-2xl nav-icon" aria-hidden="true"></i>
                <span>Progreso</span>
            </button>
            <button class="nav-item flex flex-col items-center text-sm font-medium text-gray-700 hover:text-indigo-600" data-tab="history" aria-label="Historial de tareas">
                <i class="fas fa-history text-2xl nav-icon" aria-hidden="true"></i>
                <span>Historial</span>
            </button>
        </nav>
    </header>

    <!-- Global App Message Display -->
    <div id="appMessage" class="hidden" role="alert" aria-live="assertive"></div>

    <!-- Indicador de deslizamiento -->
    <div id="swipeIndicator" class="swipe-indicator">Desliza para cambiar de pestaña</div>

    <!-- Main Content Area -->
    <main class="flex-grow p-4 pb-20">

        <!-- Sección "Hoy" (Tareas de Limpieza) -->
        <section id="today" class="tab-content active-tab">
            <h1 class="text-2xl font-bold text-gray-800 mb-4 text-center">Tareas de Limpieza</h1>
            <div id="taskList" class="space-y-3">
                <!-- Las tareas se cargarán aquí dinámicamente -->
            </div>
            <div id="taskLoader" class="hidden">
                <div class="loader"></div>
            </div>
        </section>

        <!-- Sección "Pendientes" (Tareas no completadas) -->
        <section id="pending" class="tab-content hidden">
            <h1 class="text-2xl font-bold text-gray-800 mb-4 text-center">Tareas Pendientes</h1>
            <div id="pendingTaskList" class="space-y-3">
                <!-- Las tareas pendientes se cargarán aquí dinámicamente -->
            </div>
            <div id="pendingTaskLoader" class="hidden">
                <div class="loader"></div>
            </div>
        </section>

        <!-- Sección "Calendario" -->
        <section id="calendar" class="tab-content hidden">
            <h1 class="text-2xl font-bold text-gray-800 mb-4 text-center">Calendario de Tareas</h1>
            <div class="bg-white rounded-2xl shadow-md p-4">
                <div class="flex justify-between items-center mb-4">
                    <button id="prevMonthBtn" class="bg-indigo-500 hover:bg-indigo-600 text-white p-2 rounded-full" aria-label="Mes anterior">
                        <i class="fas fa-chevron-left"></i>
                    </button>
                    <h2 id="currentMonthYear" class="text-xl font-semibold text-gray-800"></h2>
                    <button id="nextMonthBtn" class="bg-indigo-500 hover:bg-indigo-600 text-white p-2 rounded-full" aria-label="Mes siguiente">
                        <i class="fas fa-chevron-right"></i>
                    </button>
                </div>
                <div id="calendar-grid">
                    <!-- Calendar days will be rendered here -->
                </div>
            </div>
        </section>

        <!-- Sección "Notas" (Repositorio de Notas unificadas) -->
        <section id="notes" class="tab-content hidden">
            <h1 class="text-2xl font-bold text-gray-800 mb-4 text-center">Mis Notas</h1>
            <div class="mb-4">
                <input type="text" id="noteSearch" placeholder="Buscar notas por título o contenido..." class="w-full p-3 rounded-lg border border-gray-300 focus:ring-blue-500 focus:border-blue-500" aria-label="Buscar notas">
            </div>
            <div id="noteList" class="space-y-3">
                <!-- Las notas se cargarán aquí dinámicamente -->
            </div>
            <div id="noteLoader" class="hidden">
                <div class="loader"></div>
            </div>
        </section>

        <!-- Sección "Progreso" -->
        <section id="progress" class="tab-content hidden">
            <h1 class="text-2xl font-bold text-gray-800 mb-4 text-center">Mi Progreso</h1>
            <div class="bg-white rounded-2xl shadow-md p-6 text-center space-y-6">
                <h2 class="text-xl font-semibold text-gray-700">Resumen de Tareas Completadas</h2>
                <div>
                    <p class="text-lg text-gray-600">Total de tareas creadas: <span id="totalTasksCreated" class="font-bold text-indigo-600">0</span></p>
                    <p class="text-lg text-gray-600">Tareas completadas: <span id="totalTasksCompleted" class="font-bold text-green-600">0</span></p>
                </div>

                <div>
                    <h3 class="text-lg font-semibold text-gray-700 mb-2">Porcentaje de Completación</h3>
                    <div class="progress-bar-container">
                        <div id="completionProgressBar" class="progress-bar-fill" style="width: 0%;">0%</div>
                    </div>
                </div>

                <div>
                    <h3 class="text-lg font-semibold text-gray-700 mb-2">Mensaje Motivacional</h3>
                    <p id="motivationalMessage" class="text-gray-700 italic text-base">¡Vamos a empezar a organizar tu hogar!</p>
                </div>
            </div>
        </section>

        <!-- Sección "Historial" (Tareas completadas) -->
        <section id="history" class="tab-content hidden">
            <h1 class="text-2xl font-bold text-gray-800 mb-4 text-center">Historial de Tareas</h1>
            <div id="historyTaskList" class="space-y-3">
                <!-- Las tareas completadas se cargarán aquí dinámicamente -->
            </div>
            <div id="historyTaskLoader" class="hidden">
                <div class="loader"></div>
            </div>
        </section>

    </main>

    <!-- Modal para Añadir/Editar Tarea de Limpieza -->
    <div id="taskModal" class="modal fixed inset-0 flex items-center justify-center p-4 hidden" role="dialog" aria-modal="true" aria-labelledby="taskModalTitle">
        <div class="modal-content w-full max-w-lg p-6 space-y-4">
            <h2 id="taskModalTitle" class="text-2xl font-bold text-gray-800 mb-4">Añadir Nueva Tarea</h2>
            <input type="hidden" id="taskId">
            <div>
                <label for="taskName" class="block text-gray-700 font-medium mb-2">
                    Nombre de la Tarea
                    <span class="sr-only">(requerido)</span>
                </label>
                <input type="text" id="taskName" placeholder="Ej: Limpiar el baño" class="focus:ring-indigo-500 focus:border-indigo-500" required>
            </div>
            <div>
                <label for="taskDescription" class="block text-gray-700 font-medium mb-2">Descripción (Opcional)</label>
                <textarea id="taskDescription" rows="2" placeholder="Detalles específicos de la tarea" class="focus:ring-indigo-500 focus:border-indigo-500"></textarea>
            </div>
            <div>
                <label for="taskCategory" class="block text-gray-700 font-medium mb-2">Categoría</label>
                <select id="taskCategory" class="focus:ring-indigo-500 focus:border-indigo-500">
                    <option value="Baño">Baño</option>
                    <option value="Cocina">Cocina</option>
                    <option value="Suelo">Suelo</option>
                    <option value="Dormitorio">Dormitorio</option>
                    <option value="General">General</option>
                    <option value="Pasillo">Pasillo</option>
                    <option value="Balcón">Balcón</option>
                    <option value="Otro">Otro</option>
                </select>
            </div>
            <div id="frequencyFields">
                <label for="taskFrequencyUnit" class="block text-gray-700 font-medium mb-2">Frecuencia</label>
                <div class="flex space-x-2">
                    <input type="number" id="taskFrequencyValue" min="1" value="1" class="w-1/3 focus:ring-indigo-500 focus:border-indigo-500">
                    <select id="taskFrequencyUnit" class="w-2/3 focus:ring-indigo-500 focus:border-indigo-500">
                        <option value="days">Días</option>
                        <option value="weeks">Semanas</option>
                        <option value="months">Meses</option>
                        <option value="years">Años</option>
                        <option value="specific_days">Días de la Semana</option>
                    </select>
                </div>
            </div>
            <div id="taskStartDateContainer" class="hidden">
                <label for="taskStartDate" class="block text-gray-700 font-medium mb-2">Fecha de Inicio</label>
                <input type="date" id="taskStartDate" class="focus:ring-indigo-500 focus:border-indigo-500">
            </div>
            <div id="daysOfWeekSelection" class="mt-4 hidden">
                <label class="block text-gray-700 font-medium mb-2">Selecciona los días:</label>
                <div class="grid grid-cols-2 sm:grid-cols-3 gap-2 text-sm">
                    <label class="flex items-center">
                        <input type="checkbox" name="daysOfWeek" value="0" class="mr-2 rounded text-indigo-600 focus:ring-indigo-500"> Domingo
                    </label>
                    <label class="flex items-center">
                        <input type="checkbox" name="daysOfWeek" value="1" class="mr-2 rounded text-indigo-600 focus:ring-indigo-500"> Lunes
                    </label>
                    <label class="flex items-center">
                        <input type="checkbox" name="daysOfWeek" value="2" class="mr-2 rounded text-indigo-600 focus:ring-indigo-500"> Martes
                    </label>
                    <label class="flex items-center">
                        <input type="checkbox" name="daysOfWeek" value="3" class="mr-2 rounded text-indigo-600 focus:ring-indigo-500"> Miércoles
                    </label>
                    <label class="flex items-center">
                        <input type="checkbox" name="daysOfWeek" value="4" class="mr-2 rounded text-indigo-600 focus:ring-indigo-500"> Jueves
                    </label>
                    <label class="flex items-center">
                        <input type="checkbox" name="daysOfWeek" value="5" class="mr-2 rounded text-indigo-600 focus:ring-indigo-500"> Viernes
                    </label>
                    <label class="flex items-center">
                        <input type="checkbox" name="daysOfWeek" value="6" class="mr-2 rounded text-indigo-600 focus:ring-indigo-500"> Sábado
                    </label>
                </div>
            </div>
            <div class="flex justify-end space-x-4 mt-6">
                <button id="cancelTaskBtn" class="bg-gray-200 hover:bg-gray-300 text-gray-800 font-semibold py-2 px-4 rounded-xl">Cancelar</button>
                <button id="saveTaskBtn" class="bg-indigo-600 hover:bg-indigo-700 text-white font-semibold py-2 px-4 rounded-xl">Guardar Tarea</button>
            </div>
        </div>
    </div>

    <!-- Modal para Añadir/Editar Nota General -->
    <div id="noteModal" class="modal fixed inset-0 flex items-center justify-center p-4 hidden" role="dialog" aria-modal="true" aria-labelledby="noteModalTitle">
        <div class="modal-content w-full max-w-lg p-6 space-y-4">
            <h2 id="noteModalTitle" class="text-2xl font-bold text-gray-800 mb-4">Añadir Nueva Nota</h2>
            <input type="hidden" id="noteId">
            <div>
                <label for="noteTitle" class="block text-gray-700 font-medium mb-2">
                    Título de la Nota
                    <span class="sr-only">(requerido)</span>
                </label>
                <input type="text" id="noteTitle" placeholder="Ej: Lentejas de la abuela / Cambiar filtro de agua" class="focus:ring-blue-500 focus:border-blue-500" required>
            </div>
            <div>
                <label for="noteContent" class="block text-gray-700 font-medium mb-2">Contenido de la Nota</label>
                <textarea id="noteContent" rows="6" placeholder="Pasos para preparar la receta / Detalles de la nota" class="focus:ring-blue-500 focus:border-blue-500"></textarea>
            </div>
            <div class="mt-4">
                <label for="noteFile" class="block text-gray-700 font-medium mb-2">Adjuntar Archivo (Opcional)</label>
                <input type="file" id="noteFile" class="focus:ring-blue-500 focus:border-blue-500">
                <p class="text-red-500 text-xs mt-1">
                    Advertencia: Los archivos se guardan localmente en tu navegador.
                    Evita adjuntar archivos grandes (max ~5MB total).
                </p>
                <div id="currentAttachedFile" class="mt-2 text-sm text-gray-600 hidden">
                    Archivo actual: <span id="attachedFileName" class="font-medium"></span>
                    <button id="removeAttachedFile" class="text-red-500 hover:text-red-700 ml-2"><i class="fas fa-times-circle"></i> Eliminar</button>
                </div>
            </div>
            <div class="flex justify-end space-x-4 mt-6">
                <button id="cancelNoteBtn" class="bg-gray-200 hover:bg-gray-300 text-gray-800 font-semibold py-2 px-4 rounded-xl">Cancelar</button>
                <button id="saveNoteBtn" class="bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 px-4 rounded-xl">Guardar Nota</button>
            </div>
        </div>
    </div>

    <!-- Modal de Confirmación Personalizado -->
    <div id="confirmModal" class="modal fixed inset-0 flex items-center justify-center p-4 hidden" role="dialog" aria-modal="true" aria-labelledby="confirmMessage">
        <div class="modal-content w-full max-w-sm p-6 space-y-4 text-center">
            <p id="confirmMessage" class="text-lg font-medium text-gray-700"></p>
            <div class="flex justify-center space-x-4 mt-6">
                <button id="confirmCancelBtn" class="bg-gray-200 hover:bg-gray-300 text-gray-800 font-semibold py-2 px-4 rounded-xl">Cancelar</button>
                <button id="confirmOkBtn" class="bg-red-600 hover:bg-red-700 text-white font-semibold py-2 px-4 rounded-xl">Confirmar</button>
            </div>
        </div>
    </div>

    <!-- Modal para mostrar tareas del día en el calendario -->
    <div id="dayTasksModal" class="modal fixed inset-0 flex items-center justify-center p-4 hidden" role="dialog" aria-modal="true" aria-labelledby="dayTasksModalTitle">
        <div class="modal-content w-full max-w-md p-6 space-y-4">
            <h2 id="dayTasksModalTitle" class="text-2xl font-bold text-gray-800 mb-4">Tareas para [Fecha]</h2>
            <ul id="dayTasksModalContent" class="max-h-80 overflow-y-auto">
                <!-- Tasks will be listed here -->
            </ul>
            <div class="flex justify-end mt-4">
                <button id="closeDayTasksModalBtn" class="bg-gray-200 hover:bg-gray-300 text-gray-800 font-semibold py-2 px-4 rounded-xl">Cerrar</button>
            </div>
        </div>
    </div>

    <!-- Botones flotantes -->
    <button id="addTaskBtn" class="add-task-btn text-white font-semibold shadow-lg flex items-center justify-center" aria-label="Añadir tarea">
        <i class="fas fa-plus text-xl"></i>
    </button>
    <button id="addNoteBtn" class="add-note-btn text-white font-semibold shadow-lg flex items-center justify-center hidden" aria-label="Añadir nota">
        <i class="fas fa-plus text-xl"></i>
    </button>

    <script>
        // Funciones de utilidad para manejar el almacenamiento local
        const storageKey = 'houseControlApp'; // Clave principal para localStorage
        const appMessageDiv = document.getElementById('appMessage');
        let messageTimeout;

        // Muestra un mensaje temporal en la parte superior de la pantalla
        function showMessage(message, type = 'error', duration = 3000) {
            clearTimeout(messageTimeout);
            appMessageDiv.textContent = message;
            appMessageDiv.className = ``; // Reset classes
            appMessageDiv.classList.add('show', type); // Add type class for styling (error/success)
            appMessageDiv.classList.remove('hidden'); // Ensure it's visible

            messageTimeout = setTimeout(() => {
                appMessageDiv.classList.remove('show');
                appMessageDiv.classList.add('hidden'); // Hide after transition
            }, duration);
        }

        // Carga los datos de localStorage
        function loadData() {
            const data = localStorage.getItem(storageKey);
            return data ? JSON.parse(data) : {
                tasks: [],
                notes: [] // Ahora unificado
            };
        }

        // Guarda los datos en localStorage
        function saveData(data) {
            localStorage.setItem(storageKey, JSON.stringify(data));
        }

        let appData = loadData(); // Carga los datos al iniciar la aplicación

        // --- Gestión de Tareas de Limpieza ---

        // Función para renderizar una tarea individual
        function renderTask(task) {
            const now = new Date();
            const lastCompleted = task.lastCompleted ? new Date(task.lastCompleted) : null;
            let nextDueDate = null;

            // Determine the base date for recurrence calculation
            let baseDateForRecurrence = lastCompleted;
            if (!lastCompleted && task.startDate) {
                // If never completed and a start date is specified, use it as the base
                baseDateForRecurrence = new Date(task.startDate);
            }

            if (task.frequencyUnit === 'specific_days' && task.daysOfWeek && task.daysOfWeek.length > 0) {
                let currentSearchDate = baseDateForRecurrence ? new Date(baseDateForRecurrence) : new Date(now);
                if (baseDateForRecurrence && lastCompleted) { // Only increment if based on lastCompletion
                    currentSearchDate.setDate(currentSearchDate.getDate() + 1);
                }

                let foundNextDay = false;
                for (let i = 0; i < 14; i++) { // Check up to 14 days to ensure we find a next day
                    const dayOfWeek = currentSearchDate.getDay(); // 0 = Sunday, 6 = Saturday
                    if (task.daysOfWeek.includes(String(dayOfWeek))) { // daysOfWeek stores strings
                        nextDueDate = new Date(currentSearchDate);
                        foundNextDay = true;
                        break;
                    }
                    currentSearchDate.setDate(currentSearchDate.getDate() + 1);
                }

                if (!foundNextDay) { // Fallback if no day found in the loop within 14 days
                    let tempDate = baseDateForRecurrence ? new Date(baseDateForRecurrence) : new Date(now);
                    if (baseDateForRecurrence && lastCompleted) {
                        tempDate.setDate(tempDate.getDate() + 1);
                    }
                    for(let i = 0; i < 7; i++) { // Search for the next valid day within 7 days
                        const dayToCheck = (tempDate.getDay() + i) % 7;
                        if (task.daysOfWeek.includes(String(dayToCheck))) {
                            nextDueDate = new Date(tempDate);
                            nextDueDate.setDate(tempDate.getDate() + i);
                            break;
                        }
                    }
                }

                // Ensure nextDueDate is not before startDate if startDate is present and relevant
                if (task.startDate && nextDueDate && new Date(task.startDate) > nextDueDate) {
                    let tempStartDate = new Date(task.startDate);
                    let foundValidDayFromStart = false;
                    for (let i = 0; i < 7; i++) {
                        const dayOfWeek = tempStartDate.getDay();
                        if (task.daysOfWeek.includes(String(dayOfWeek))) {
                            nextDueDate = new Date(tempStartDate);
                            foundValidDayFromStart = true;
                            break;
                        }
                        tempStartDate.setDate(tempStartDate.getDate() + 1);
                    }
                    if (!foundValidDayFromStart) { // Fallback if no day found, just set to start date
                        nextDueDate = new Date(task.startDate);
                    }
                }

            } else if (baseDateForRecurrence) {
                // Original frequency logic (days, weeks, months, years)
                nextDueDate = new Date(baseDateForRecurrence);
                if (task.frequencyUnit === 'days') {
                    nextDueDate.setDate(nextDueDate.getDate() + task.frequencyValue);
                } else if (task.frequencyUnit === 'weeks') {
                    nextDueDate.setDate(nextDueDate.getDate() + (task.frequencyValue * 7));
                } else if (task.frequencyUnit === 'months') {
                    nextDueDate.setMonth(nextDueDate.getMonth() + task.frequencyValue);
                } else if (task.frequencyUnit === 'years') {
                    nextDueDate.setFullYear(nextDueDate.getFullYear() + task.frequencyValue);
                }
            } else {
                nextDueDate = now; // If never completed and no start date, consider it due "today"
            }

            // Apply postponement if exists and is later than the calculated nextDueDate
            if (task.postponeUntilDate) {
                const postponeDate = new Date(task.postponeUntilDate);
                if (postponeDate > nextDueDate) {
                    nextDueDate = postponeDate;
                }
            }

            const isDueToday = nextDueDate && nextDueDate.toDateString() === now.toDateString() && !task.isCompleted;
            const isOverdue = nextDueDate && nextDueDate < now && !task.isCompleted;
            const isCompleted = task.isCompleted;

            let statusText = '';
            let cardClasses = `task-card p-4 flex flex-col sm:flex-row items-start sm:items-center space-y-3 sm:space-y-0 sm:space-x-4 ${isCompleted ? 'completed-task' : ''} category-${task.category.toLowerCase().replace(/\s/g, '')}`;

            if (isCompleted) {
                statusText = `Completada: ${formatDate(new Date(task.lastCompleted))}`;
                cardClasses = `task-card p-4 flex flex-col sm:flex-row items-start sm:items-center space-y-3 sm:space-y-0 sm:space-x-4 completed-task category-${task.category.toLowerCase().replace(/\s/g, '')}`;
            } else if (isDueToday) {
                statusText = 'Vence Hoy';
                cardClasses = `task-card p-4 flex flex-col sm:flex-row items-start sm:items-center space-y-3 sm:space-y-0 sm:space-x-4 border-l-8 border-red-500 category-${task.category.toLowerCase().replace(/\s/g, '')}`;
            } else if (isOverdue) {
                statusText = `Atrasada: ${formatDate(nextDueDate)}`;
                cardClasses = `task-card p-4 flex flex-col sm:flex-row items-start sm:items-center space-y-3 sm:space-y-0 sm:space-x-4 border-l-8 border-red-700 category-${task.category.toLowerCase().replace(/\s/g, '')}`;
            } else if (nextDueDate) {
                statusText = `Próxima: ${formatDate(nextDueDate)}`;
            } else {
                statusText = 'Sin fecha';
            }

            const iconClass = getCategoryIcon(task.category);

            return `
                <div class="${cardClasses} fade-in" data-id="${task.id}">
                    <div class="text-3xl text-gray-600 ${getCategoryColorClass(task.category)} flex-shrink-0">
                        <i class="${iconClass}"></i>
                    </div>
                    <div class="flex-grow">
                        <h3 class="text-lg font-semibold">${task.name}</h3>
                        <p class="text-gray-500 text-sm">${task.category}</p>
                        <p class="text-gray-600 text-sm font-medium">${statusText}</p>
                    </div>
                    <div class="flex flex-wrap gap-2">
                        ${!isCompleted ? `<button class="action-btn complete-btn bg-green-500 hover:bg-green-600 text-white" aria-label="Completar tarea"><i class="fas fa-check"></i></button>` : ''}
                        ${!isCompleted ? `<button class="action-btn postpone-btn bg-yellow-500 hover:bg-yellow-600 text-white" aria-label="Posponer tarea"><i class="fas fa-forward"></i></button>` : ''}
                        <button class="action-btn edit-btn bg-blue-500 hover:bg-blue-600 text-white" aria-label="Editar tarea"><i class="fas fa-edit"></i></button>
                        <button class="action-btn delete-btn bg-red-500 hover:bg-red-600 text-white" aria-label="Eliminar tarea"><i class="fas fa-trash"></i></button>
                    </div>
                </div>
            `;
        }

        // Obtiene el icono para la categoría
        function getCategoryIcon(category) {
            switch (category) {
                case 'Baño': return 'fas fa-toilet';
                case 'Suelo': return 'fas fa-broom';
                case 'Cocina': return 'fas fa-utensils';
                case 'Dormitorio': return 'fas fa-bed';
                case 'General': return 'fas fa-house-cleaning';
                case 'Pasillo': return 'fas fa-route';
                case 'Balcón': return 'fas fa-wind';
                default: return 'fas fa-tasks';
            }
        }

        // Obtiene la clase de color para el icono de la categoría
        function getCategoryColorClass(category) {
            switch (category) {
                case 'Baño': return 'text-teal-500';
                case 'Suelo': return 'text-purple-500';
                case 'Cocina': return 'text-orange-500';
                case 'Dormitorio': return 'text-blue-500';
                case 'General': return 'text-red-500';
                case 'Pasillo': return 'text-gray-500';
                case 'Balcón': return 'text-green-500';
                default: return 'text-indigo-500';
            }
        }

        // Formatea la fecha para mostrar
        function formatDate(date) {
            return date.toLocaleDateString('es-ES', { day: '2-digit', month: '2-digit', year: 'numeric' });
        }

        // Renderiza todas las tareas en las listas correspondientes
        function renderAllTasks() {
            const taskListDiv = document.getElementById('taskList');
            const pendingTaskListDiv = document.getElementById('pendingTaskList');
            const historyTaskListDiv = document.getElementById('historyTaskList');

            // Mostrar indicadores de carga
            document.getElementById('taskLoader').classList.remove('hidden');
            document.getElementById('pendingTaskLoader').classList.remove('hidden');
            document.getElementById('historyTaskLoader').classList.remove('hidden');

            // Usar requestAnimationFrame para mejor rendimiento
            requestAnimationFrame(() => {
                taskListDiv.innerHTML = '';
                pendingTaskListDiv.innerHTML = '';
                historyTaskListDiv.innerHTML = '';

                const now = new Date();
                const todayTasks = [];
                const pendingTasks = [];
                const historyTasks = [];

                appData.tasks.forEach(task => {
                    let nextDueDate = null;
                    const lastCompleted = task.lastCompleted ? new Date(task.lastCompleted) : null;

                    // Determine the base date for recurrence calculation
                    let baseDateForRecurrence = lastCompleted;
                    if (!lastCompleted && task.startDate) {
                        baseDateForRecurrence = new Date(task.startDate);
                    } else if (!lastCompleted) {
                        baseDateForRecurrence = now; // Fallback if no lastCompleted and no startDate
                    }

                    if (task.frequencyUnit === 'specific_days' && task.daysOfWeek && task.daysOfWeek.length > 0) {
                        let currentSearchDate = new Date(baseDateForRecurrence);
                        if (lastCompleted) { // Only increment if based on lastCompletion
                            currentSearchDate.setDate(currentSearchDate.getDate() + 1);
                        }

                        let foundNextDay = false;
                        for (let i = 0; i < 14; i++) {
                            const dayOfWeek = currentSearchDate.getDay();
                            if (task.daysOfWeek.includes(String(dayOfWeek))) {
                                nextDueDate = new Date(currentSearchDate);
                                foundNextDay = true;
                                break;
                            }
                            currentSearchDate.setDate(currentSearchDate.getDate() + 1);
                        }

                        // Ensure nextDueDate is not before startDate if startDate is present and relevant
                        if (task.startDate && nextDueDate && new Date(task.startDate) > nextDueDate) {
                            let tempStartDate = new Date(task.startDate);
                            let foundValidDayFromStart = false;
                            for (let i = 0; i < 7; i++) {
                                const dayOfWeek = tempStartDate.getDay();
                                if (task.daysOfWeek.includes(String(dayOfWeek))) {
                                    nextDueDate = new Date(tempStartDate);
                                    foundValidDayFromStart = true;
                                    break;
                                }
                                tempStartDate.setDate(tempStartDate.getDate() + 1);
                            }
                            if (!foundValidDayFromStart) { // Fallback if no day found, just set to start date
                                nextDueDate = new Date(task.startDate);
                            }
                        }

                    } else if (baseDateForRecurrence) {
                        nextDueDate = new Date(baseDateForRecurrence);
                        if (task.frequencyUnit === 'days') {
                            nextDueDate.setDate(nextDueDate.getDate() + task.frequencyValue);
                        } else if (task.frequencyUnit === 'weeks') {
                            nextDueDate.setDate(nextDueDate.getDate() + (task.frequencyValue * 7));
                        } else if (task.frequencyUnit === 'months') {
                            nextDueDate.setMonth(nextDueDate.getMonth() + task.frequencyValue);
                        } else if (task.frequencyUnit === 'years') {
                            nextDueDate.setFullYear(nextDueDate.getFullYear() + task.frequencyValue);
                        }
                    } else {
                        nextDueDate = now;
                    }

                    // Apply postponement if exists and is later than the calculated nextDueDate
                    if (task.postponeUntilDate) {
                        const postponeDate = new Date(task.postponeUntilDate);
                        if (postponeDate > nextDueDate) {
                            nextDueDate = postponeDate;
                        }
                    }

                    const isDueToday = nextDueDate && nextDueDate.toDateString() === now.toDateString();
                    const isOverdue = nextDueDate && nextDueDate < now;

                    if (task.isCompleted) {
                        historyTasks.push(task);
                    } else if (isDueToday || isOverdue) {
                        todayTasks.push(task);
                    } else {
                        pendingTasks.push(task);
                    }
                });

                // Renderizar tareas con un pequeño retraso para mejor UX
                setTimeout(() => {
                    todayTasks.forEach(task => taskListDiv.innerHTML += renderTask(task));
                    pendingTasks.forEach(task => pendingTaskListDiv.innerHTML += renderTask(task));
                    historyTasks.sort((a, b) => new Date(b.lastCompleted) - new Date(a.lastCompleted));
                    historyTasks.forEach(task => historyTaskListDiv.innerHTML += renderTask(task));

                    // Ocultar indicadores de carga
                    document.getElementById('taskLoader').classList.add('hidden');
                    document.getElementById('pendingTaskLoader').classList.add('hidden');
                    document.getElementById('historyTaskLoader').classList.add('hidden');

                    addEventListenersToTaskButtons();
                }, 100);
            });
        }

        // Abre el modal de tarea para añadir o editar
        function openTaskModal(task = null) {
            const taskModal = document.getElementById('taskModal');
            const taskIdInput = document.getElementById('taskId');
            const taskNameInput = document.getElementById('taskName');
            const taskDescriptionInput = document.getElementById('taskDescription');
            const taskCategorySelect = document.getElementById('taskCategory');
            const taskFrequencyValueInput = document.getElementById('taskFrequencyValue');
            const taskFrequencyUnitSelect = document.getElementById('taskFrequencyUnit');
            const daysOfWeekSelectionDiv = document.getElementById('daysOfWeekSelection');
            const daysOfWeekCheckboxes = document.querySelectorAll('#daysOfWeekSelection input[type="checkbox"]');
            const frequencyFieldsDiv = document.getElementById('frequencyFields'); // Contains value and unit select
            const taskStartDateContainer = document.getElementById('taskStartDateContainer');
            const taskStartDateInput = document.getElementById('taskStartDate');
            const taskModalTitle = document.getElementById('taskModalTitle');

            // Reset form
            taskIdInput.value = '';
            taskNameInput.value = '';
            taskDescriptionInput.value = '';
            taskCategorySelect.value = 'General';
            taskFrequencyValueInput.value = '1';
            taskFrequencyUnitSelect.value = 'weeks';
            daysOfWeekCheckboxes.forEach(checkbox => checkbox.checked = false);
            taskStartDateInput.value = ''; // Reset start date

            const today = new Date();
            const todayISO = today.toISOString().split('T')[0]; // Format YYYY-MM-DD

            if (task) {
                taskModalTitle.textContent = 'Editar Tarea';
                taskIdInput.value = task.id;
                taskNameInput.value = task.name;
                taskDescriptionInput.value = task.description || '';
                taskCategorySelect.value = task.category;
                taskFrequencyUnitSelect.value = task.frequencyUnit || 'weeks';

                if (task.startDate) {
                    taskStartDateInput.value = new Date(task.startDate).toISOString().split('T')[0];
                } else {
                    taskStartDateInput.value = todayISO;
                }

                // Show/hide frequency-related fields
                if (['days', 'weeks', 'months', 'years'].includes(task.frequencyUnit)) {
                    frequencyFieldsDiv.classList.remove('hidden'); // Show value and unit
                    daysOfWeekSelectionDiv.classList.add('hidden'); // Hide specific days
                    taskFrequencyValueInput.value = task.frequencyValue || 1;
                    taskStartDateContainer.classList.remove('hidden'); // Show start date for recurrences
                } else if (task.frequencyUnit === 'specific_days') {
                    frequencyFieldsDiv.classList.add('hidden'); // Hide value and unit
                    daysOfWeekSelectionDiv.classList.remove('hidden'); // Show specific days
                    taskStartDateContainer.classList.remove('hidden'); // Show start date for recurrences
                    if (task.daysOfWeek) {
                        task.daysOfWeek.forEach(day => {
                            const checkbox = document.querySelector(`#daysOfWeekSelection input[value="${day}"]`);
                            if (checkbox) checkbox.checked = true;
                        });
                    }
                } else { // No recurrence or one-time task
                    frequencyFieldsDiv.classList.remove('hidden');
                    daysOfWeekSelectionDiv.classList.add('hidden');
                    taskStartDateContainer.classList.add('hidden'); // Hide start date if not recurring
                }

            } else {
                taskModalTitle.textContent = 'Añadir Nueva Tarea';
                frequencyFieldsDiv.classList.remove('hidden');
                daysOfWeekSelectionDiv.classList.add('hidden');
                taskStartDateContainer.classList.remove('hidden'); // Show start date by default for new tasks
                taskStartDateInput.value = todayISO; // Default to today's date for new tasks
            }
            taskModal.classList.remove('hidden');
        }

        // Cierra el modal de tarea
        function closeTaskModal() {
            document.getElementById('taskModal').classList.add('hidden');
        }

        // Manejar el cambio en la unidad de frecuencia para mostrar/ocultar días de la semana y fecha de inicio
        document.getElementById('taskFrequencyUnit').addEventListener('change', (e) => {
            const daysOfWeekSelectionDiv = document.getElementById('daysOfWeekSelection');
            const frequencyFieldsDiv = document.getElementById('frequencyFields');
            const taskStartDateContainer = document.getElementById('taskStartDateContainer');
            const taskFrequencyValueInput = document.getElementById('taskFrequencyValue');

            const selectedUnit = e.target.value;

            if (selectedUnit === 'specific_days') {
                daysOfWeekSelectionDiv.classList.remove('hidden');
                frequencyFieldsDiv.classList.add('hidden'); // Ocultar input de valor y selector de unidad
                taskStartDateContainer.classList.remove('hidden'); // Always show start date for specific days
            } else if (['days', 'weeks', 'months', 'years'].includes(selectedUnit)) {
                daysOfWeekSelectionDiv.classList.add('hidden');
                frequencyFieldsDiv.classList.remove('hidden'); // Mostrar input de valor y selector de unidad
                taskFrequencyValueInput.value = '1';
                taskStartDateContainer.classList.remove('hidden'); // Show start date for other recurrences
            } else { // Handle any other non-recurring case, though current options are all recurring
                daysOfWeekSelectionDiv.classList.add('hidden');
                frequencyFieldsDiv.classList.remove('hidden');
                taskFrequencyValueInput.value = '1';
                taskStartDateContainer.classList.add('hidden'); // Hide start date if not recurring
            }
        });

        // Añade/Edita una tarea
        document.getElementById('saveTaskBtn').addEventListener('click', () => {
            const taskId = document.getElementById('taskId').value;
            const taskName = document.getElementById('taskName').value.trim();
            const taskDescription = document.getElementById('taskDescription').value.trim();
            const taskCategory = document.getElementById('taskCategory').value;
            const taskFrequencyUnit = document.getElementById('taskFrequencyUnit').value;
            const taskStartDate = document.getElementById('taskStartDate').value; // Get the start date

            let taskFrequencyValue = null;
            let daysOfWeek = [];
            let startDateToSave = null;

            if (!taskName) {
                showMessage('El nombre de la tarea no puede estar vacío.', 'error');
                return;
            }

            // Validate and set recurrence details
            if (taskFrequencyUnit === 'specific_days') {
                daysOfWeek = Array.from(document.querySelectorAll('#daysOfWeekSelection input[type="checkbox"]:checked'))
                               .map(checkbox => checkbox.value);
                if (daysOfWeek.length === 0) {
                    showMessage('Debes seleccionar al menos un día de la semana para esta frecuencia.', 'error');
                    return;
                }
                // Ensure a start date is provided for specific days
                if (!taskStartDate) {
                    showMessage('Debes seleccionar una fecha de inicio para esta frecuencia.', 'error');
                    return;
                }
                startDateToSave = taskStartDate;
            } else if (['days', 'weeks', 'months', 'years'].includes(taskFrequencyUnit)) {
                taskFrequencyValue = parseInt(document.getElementById('taskFrequencyValue').value);
                if (isNaN(taskFrequencyValue) || taskFrequencyValue <= 0) {
                    showMessage('La frecuencia debe ser un número positivo.', 'error');
                    return;
                }
                // Ensure a start date is provided for other recurring tasks
                if (!taskStartDate) {
                    showMessage('Debes seleccionar una fecha de inicio para esta frecuencia.', 'error');
                    return;
                }
                startDateToSave = taskStartDate;
            }
            // If it's a non-recurring task, startDateToSave will remain null/empty

            if (taskId) {
                // Editar tarea existente
                const taskIndex = appData.tasks.findIndex(t => t.id === taskId);
                if (taskIndex > -1) {
                    appData.tasks[taskIndex] = {
                        ...appData.tasks[taskIndex],
                        name: taskName,
                        description: taskDescription,
                        category: taskCategory,
                        frequencyValue: taskFrequencyValue,
                        frequencyUnit: taskFrequencyUnit,
                        daysOfWeek: daysOfWeek.length > 0 ? daysOfWeek : null, // Store null if no specific days
                        startDate: startDateToSave // Save the start date
                    };
                }
            } else {
                // Añadir nueva tarea
                const newTask = {
                    id: crypto.randomUUID(),
                    name: taskName,
                    description: taskDescription,
                    category: taskCategory,
                    frequencyValue: taskFrequencyValue,
                    frequencyUnit: taskFrequencyUnit,
                    daysOfWeek: daysOfWeek.length > 0 ? daysOfWeek : null,
                    startDate: startDateToSave, // Save the start date
                    lastCompleted: null,
                    isCompleted: false,
                    postponeUntilDate: null // New property for postponement
                };
                appData.tasks.push(newTask);
            }
            saveData(appData);
            renderAllTasks();
            closeTaskModal();
            showMessage('Tarea guardada con éxito.', 'success');
        });

        // Event listener para el botón "Añadir tarea"
        document.getElementById('addTaskBtn').addEventListener('click', () => openTaskModal());
        document.getElementById('cancelTaskBtn').addEventListener('click', closeTaskModal);

        // Añadir event listeners a los botones de las tarjetas de tareas
        function addEventListenersToTaskButtons() {
            document.querySelectorAll('.complete-btn').forEach(button => {
                button.onclick = (e) => {
                    e.stopPropagation();
                    const taskId = e.target.closest('.task-card').dataset.id;
                    const taskIndex = appData.tasks.findIndex(t => t.id === taskId);
                    if (taskIndex > -1) {
                        appData.tasks[taskIndex].lastCompleted = new Date().toISOString();
                        appData.tasks[taskIndex].isCompleted = true;
                        appData.tasks[taskIndex].postponeUntilDate = null; // Clear postponement on completion
                        saveData(appData);
                        renderAllTasks();
                        showMessage('Tarea marcada como completada.', 'success');
                        renderProgress(); // Update progress after completing a task
                    }
                };
            });

            document.querySelectorAll('.postpone-btn').forEach(button => {
                button.onclick = (e) => {
                    e.stopPropagation();
                    const taskId = e.target.closest('.task-card').dataset.id;
                    const taskIndex = appData.tasks.findIndex(t => t.id === taskId);
                    if (taskIndex > -1) {
                        const now = new Date();
                        // Postpone by 1 day from now
                        const postponeDate = new Date(now.getTime() + (24 * 60 * 60 * 1000));
                        appData.tasks[taskIndex].postponeUntilDate = postponeDate.toISOString();
                        saveData(appData);
                        renderAllTasks();
                        showMessage('Tarea pospuesta por 1 día.', 'success');
                    }
                };
            });

            document.querySelectorAll('.edit-btn').forEach(button => {
                button.onclick = (e) => {
                    e.stopPropagation();
                    const taskId = e.target.closest('.task-card').dataset.id;
                    const task = appData.tasks.find(t => t.id === taskId);
                    if (task) {
                        openTaskModal(task);
                    }
                };
            });

            document.querySelectorAll('.delete-btn').forEach(button => {
                button.onclick = (e) => {
                    e.stopPropagation();
                    const taskId = e.target.closest('.task-card').dataset.id;
                    showConfirmModal('¿Estás seguro de que quieres eliminar esta tarea?', () => {
                        appData.tasks = appData.tasks.filter(t => t.id !== taskId);
                        saveData(appData);
                        renderAllTasks();
                        showMessage('Tarea eliminada.', 'success');
                        renderProgress(); // Update progress after deleting a task
                    });
                };
            });
        }

        // --- Gestión de Notas (Unificado) ---

        // Función para renderizar una nota individual
        function renderNote(note) {
            const noteType = note.fileAttached ? 'file' : (note.title.toLowerCase().includes('receta') || note.content.toLowerCase().includes('receta') ? 'recipe' : 'text');
            const iconClass = noteType === 'file' ? 'fas fa-file' : (noteType === 'recipe' ? 'fas fa-utensils' : 'fas fa-sticky-note');
            
            return `
                <div class="note-card p-4 flex flex-col space-y-3 note-type-${noteType} fade-in" data-id="${note.id}">
                    <div class="flex justify-between items-start">
                        <div class="flex items-center space-x-3">
                            <div class="text-2xl text-gray-600">
                                <i class="${iconClass}"></i>
                            </div>
                            <div>
                                <h3 class="text-lg font-semibold">${note.title}</h3>
                                <p class="text-gray-500 text-sm">${noteType === 'file' ? 'Nota con archivo' : (noteType === 'recipe' ? 'Receta' : 'Nota de texto')}</p>
                            </div>
                        </div>
                        <div class="flex space-x-2">
                            <button class="edit-note-btn action-btn edit-btn bg-blue-500 hover:bg-blue-600 text-white" aria-label="Editar nota"><i class="fas fa-edit"></i></button>
                            <button class="delete-note-btn action-btn delete-btn bg-red-500 hover:bg-red-600 text-white" aria-label="Eliminar nota"><i class="fas fa-trash"></i></button>
                        </div>
                    </div>
                    <div class="text-gray-700 text-sm line-clamp-3">
                        ${note.content}
                    </div>
                    ${note.fileAttached ? `
                    <div class="flex items-center text-sm text-gray-600">
                        <i class="fas fa-paperclip mr-2"></i>
                        <span>Archivo adjunto</span>
                    </div>
                    ` : ''}
                </div>
            `;
        }

        // Renderiza todas las notas
        function renderAllNotes() {
            const noteListDiv = document.getElementById('noteList');
            
            // Mostrar indicador de carga
            document.getElementById('noteLoader').classList.remove('hidden');
            
            // Usar requestAnimationFrame para mejor rendimiento
            requestAnimationFrame(() => {
                noteListDiv.innerHTML = '';
                
                // Renderizar notas con un pequeño retraso para mejor UX
                setTimeout(() => {
                    appData.notes.forEach(note => {
                        noteListDiv.innerHTML += renderNote(note);
                    });
                    
                    // Ocultar indicador de carga
                    document.getElementById('noteLoader').classList.add('hidden');
                    
                    addEventListenersToNoteButtons();
                }, 100);
            });
        }

        // Filtra notas según el término de búsqueda
        function filterNotes(searchTerm) {
            const term = searchTerm.toLowerCase();
            const noteListDiv = document.getElementById('noteList');
            
            // Mostrar indicador de carga
            document.getElementById('noteLoader').classList.remove('hidden');
            
            // Usar requestAnimationFrame para mejor rendimiento
            requestAnimationFrame(() => {
                noteListDiv.innerHTML = '';
                
                const filteredNotes = appData.notes.filter(note => 
                    note.title.toLowerCase().includes(term) || 
                    note.content.toLowerCase().includes(term)
                );
                
                // Renderizar notas filtradas con un pequeño retraso para mejor UX
                setTimeout(() => {
                    filteredNotes.forEach(note => {
                        noteListDiv.innerHTML += renderNote(note);
                    });
                    
                    // Ocultar indicador de carga
                    document.getElementById('noteLoader').classList.add('hidden');
                    
                    addEventListenersToNoteButtons();
                }, 100);
            });
        }

        // Abre el modal de nota para añadir o editar
        function openNoteModal(note = null) {
            const noteModal = document.getElementById('noteModal');
            const noteIdInput = document.getElementById('noteId');
            const noteTitleInput = document.getElementById('noteTitle');
            const noteContentInput = document.getElementById('noteContent');
            const noteFileInput = document.getElementById('noteFile');
            const currentAttachedFileDiv = document.getElementById('currentAttachedFile');
            const attachedFileNameSpan = document.getElementById('attachedFileName');
            const noteModalTitle = document.getElementById('noteModalTitle');

            // Reset form
            noteIdInput.value = '';
            noteTitleInput.value = '';
            noteContentInput.value = '';
            noteFileInput.value = '';
            currentAttachedFileDiv.classList.add('hidden');

            if (note) {
                noteModalTitle.textContent = 'Editar Nota';
                noteIdInput.value = note.id;
                noteTitleInput.value = note.title;
                noteContentInput.value = note.content;
                
                if (note.fileAttached) {
                    attachedFileNameSpan.textContent = note.fileName || 'Archivo adjunto';
                    currentAttachedFileDiv.classList.remove('hidden');
                }
            } else {
                noteModalTitle.textContent = 'Añadir Nueva Nota';
            }
            noteModal.classList.remove('hidden');
        }

        // Cierra el modal de nota
        function closeNoteModal() {
            document.getElementById('noteModal').classList.add('hidden');
        }

        // Añade/Edita una nota
        document.getElementById('saveNoteBtn').addEventListener('click', () => {
            const noteId = document.getElementById('noteId').value;
            const noteTitle = document.getElementById('noteTitle').value.trim();
            const noteContent = document.getElementById('noteContent').value.trim();
            const noteFileInput = document.getElementById('noteFile');
            const currentAttachedFileDiv = document.getElementById('currentAttachedFile');
            
            if (!noteTitle) {
                showMessage('El título de la nota no puede estar vacío.', 'error');
                return;
            }

            if (noteId) {
                // Editar nota existente
                const noteIndex = appData.notes.findIndex(n => n.id === noteId);
                if (noteIndex > -1) {
                    appData.notes[noteIndex] = {
                        ...appData.notes[noteIndex],
                        title: noteTitle,
                        content: noteContent
                    };
                    
                    // Si se adjunta un nuevo archivo
                    if (noteFileInput.files.length > 0) {
                        const file = noteFileInput.files[0];
                        const reader = new FileReader();
                        
                        reader.onload = function(e) {
                            appData.notes[noteIndex].fileAttached = e.target.result;
                            appData.notes[noteIndex].fileName = file.name;
                            appData.notes[noteIndex].fileType = file.type;
                            saveData(appData);
                            renderAllNotes();
                            closeNoteModal();
                            showMessage('Nota actualizada con éxito.', 'success');
                        };
                        
                        reader.readAsDataURL(file);
                    } else {
                        // Si no se adjunta un nuevo archivo pero se eliminó el existente
                        if (currentAttachedFileDiv.classList.contains('hidden')) {
                            appData.notes[noteIndex].fileAttached = null;
                            appData.notes[noteIndex].fileName = null;
                            appData.notes[noteIndex].fileType = null;
                        }
                        
                        saveData(appData);
                        renderAllNotes();
                        closeNoteModal();
                        showMessage('Nota actualizada con éxito.', 'success');
                    }
                }
            } else {
                // Añadir nueva nota
                const newNote = {
                    id: crypto.randomUUID(),
                    title: noteTitle,
                    content: noteContent,
                    fileAttached: null,
                    fileName: null,
                    fileType: null,
                    createdAt: new Date().toISOString()
                };
                
                // Si se adjunta un archivo
                if (noteFileInput.files.length > 0) {
                    const file = noteFileInput.files[0];
                    const reader = new FileReader();
                    
                    reader.onload = function(e) {
                        newNote.fileAttached = e.target.result;
                        newNote.fileName = file.name;
                        newNote.fileType = file.type;
                        
                        appData.notes.push(newNote);
                        saveData(appData);
                        renderAllNotes();
                        closeNoteModal();
                        showMessage('Nota guardada con éxito.', 'success');
                    };
                    
                    reader.readAsDataURL(file);
                } else {
                    appData.notes.push(newNote);
                    saveData(appData);
                    renderAllNotes();
                    closeNoteModal();
                    showMessage('Nota guardada con éxito.', 'success');
                }
            }
        });

        // Event listener para el botón "Añadir nota"
        document.getElementById('addNoteBtn').addEventListener('click', () => openNoteModal());
        document.getElementById('cancelNoteBtn').addEventListener('click', closeNoteModal);

        // Eliminar archivo adjunto
        document.getElementById('removeAttachedFile').addEventListener('click', () => {
            document.getElementById('currentAttachedFile').classList.add('hidden');
        });

        // Añadir event listeners a los botones de las tarjetas de notas
        function addEventListenersToNoteButtons() {
            document.querySelectorAll('.edit-note-btn').forEach(button => {
                button.onclick = (e) => {
                    e.stopPropagation();
                    const noteId = e.target.closest('.note-card').dataset.id;
                    const note = appData.notes.find(n => n.id === noteId);
                    if (note) {
                        openNoteModal(note);
                    }
                };
            });

            document.querySelectorAll('.delete-note-btn').forEach(button => {
                button.onclick = (e) => {
                    e.stopPropagation();
                    const noteId = e.target.closest('.note-card').dataset.id;
                    showConfirmModal('¿Estás seguro de que quieres eliminar esta nota?', () => {
                        appData.notes = appData.notes.filter(n => n.id !== noteId);
                        saveData(appData);
                        renderAllNotes();
                        showMessage('Nota eliminada.', 'success');
                    });
                };
            });
        }

        // Búsqueda de notas en tiempo real con debounce
        let searchTimeout;
        document.getElementById('noteSearch').addEventListener('input', (e) => {
            clearTimeout(searchTimeout);
            searchTimeout = setTimeout(() => {
                filterNotes(e.target.value);
            }, 300);
        });

        // --- Gestión del Calendario ---

        // Variables para el calendario
        let currentMonth = new Date().getMonth();
        let currentYear = new Date().getFullYear();

        // Renderiza el calendario
        function renderCalendar() {
            const calendarGrid = document.getElementById('calendar-grid');
            const currentMonthYear = document.getElementById('currentMonthYear');
            
            // Limpiar el calendario
            calendarGrid.innerHTML = '';
            
            // Establecer el mes y año actual
            const monthNames = ['Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio', 'Julio', 'Agosto', 'Septiembre', 'Octubre', 'Noviembre', 'Diciembre'];
            currentMonthYear.textContent = `${monthNames[currentMonth]} ${currentYear}`;
            
            // Añadir encabezados de días de la semana
            const dayNames = ['Dom', 'Lun', 'Mar', 'Mié', 'Jue', 'Vie', 'Sáb'];
            dayNames.forEach(day => {
                const dayHeader = document.createElement('div');
                dayHeader.className = 'calendar-header-day';
                dayHeader.textContent = day;
                calendarGrid.appendChild(dayHeader);
            });
            
            // Obtener el primer día del mes y el número de días
            const firstDay = new Date(currentYear, currentMonth, 1).getDay();
            const daysInMonth = new Date(currentYear, currentMonth + 1, 0).getDate();
            
            // Añadir celdas vacías para los días antes del primer día del mes
            for (let i = 0; i < firstDay; i++) {
                const emptyDay = document.createElement('div');
                emptyDay.className = 'calendar-day-cell inactive';
                calendarGrid.appendChild(emptyDay);
            }
            
            // Añadir celdas para cada día del mes
            const today = new Date();
            for (let day = 1; day <= daysInMonth; day++) {
                const dayCell = document.createElement('div');
                dayCell.className = 'calendar-day-cell';
                
                // Marcar el día actual
                if (currentYear === today.getFullYear() && currentMonth === today.getMonth() && day === today.getDate()) {
                    dayCell.classList.add('today');
                }
                
                // Añadir número del día
                const dayNumber = document.createElement('div');
                dayNumber.className = 'day-number';
                dayNumber.textContent = day;
                dayCell.appendChild(dayNumber);
                
                // Obtener tareas para este día
                const dayDate = new Date(currentYear, currentMonth, day);
                const dayTasks = getTasksForDate(dayDate);
                
                // Añadir indicador de tareas
                if (dayTasks.length > 0) {
                    const taskIndicator = document.createElement('div');
                    taskIndicator.className = 'task-indicator';
                    dayCell.appendChild(taskIndicator);
                    
                    // Añadir contador de tareas
                    const taskCount = document.createElement('div');
                    taskCount.className = 'task-count';
                    taskCount.textContent = dayTasks.length;
                    dayCell.appendChild(taskCount);
                }
                
                // Añadir evento click para mostrar tareas del día
                dayCell.addEventListener('click', () => {
                    showDayTasksModal(dayDate, dayTasks);
                });
                
                calendarGrid.appendChild(dayCell);
            }
        }

        // Obtiene las tareas para una fecha específica
        function getTasksForDate(date) {
            const dayOfWeek = date.getDay(); // 0 = Sunday, 6 = Saturday
            const dateOnly = new Date(date.getFullYear(), date.getMonth(), date.getDate()); // Normalize to start of day
            const nowOnly = new Date(new Date().getFullYear(), new Date().getMonth(), new Date().getDate());

            return appData.tasks.filter(task => {
                if (task.isCompleted) return false; // Don't show completed tasks

                // If task is postponed, and the current date is before postponeUntilDate, don't show it
                if (task.postponeUntilDate) {
                    const postponeDate = new Date(task.postponeUntilDate);
                    const postponeDateOnly = new Date(postponeDate.getFullYear(), postponeDate.getMonth(), postponeDate.getDate());
                    if (dateOnly < postponeDateOnly) return false;
                }

                let nextDueDate = null;
                const lastCompleted = task.lastCompleted ? new Date(task.lastCompleted) : null;

                // Determine the base date for recurrence calculation
                let baseDateForRecurrence = lastCompleted;
                if (!lastCompleted && task.startDate) {
                    baseDateForRecurrence = new Date(task.startDate);
                } else if (!lastCompleted) {
                    baseDateForRecurrence = nowOnly; // Fallback if no lastCompleted and no startDate
                }

                if (task.frequencyUnit === 'specific_days' && task.daysOfWeek && task.daysOfWeek.length > 0) {
                    let currentSearchDate = new Date(baseDateForRecurrence);
                    if (lastCompleted) { // Only increment if based on lastCompletion
                        currentSearchDate.setDate(currentSearchDate.getDate() + 1);
                    }

                    let foundNextDay = false;
                    for (let i = 0; i < 14; i++) { // Check up to 14 days
                        const day = currentSearchDate.getDay();
                        if (task.daysOfWeek.includes(String(day))) {
                            nextDueDate = new Date(currentSearchDate);
                            foundNextDay = true;
                            break;
                        }
                        currentSearchDate.setDate(currentSearchDate.getDate() + 1);
                    }

                    // If a startDate is present and the calculated nextDueDate is before it, find the first valid day from startDate
                    if (task.startDate && nextDueDate && new Date(task.startDate) > nextDueDate) {
                        let tempStartDate = new Date(task.startDate);
                        let foundValidDayFromStart = false;
                        for (let i = 0; i < 7; i++) {
                            const day = tempStartDate.getDay();
                            if (task.daysOfWeek.includes(String(day))) {
                                nextDueDate = new Date(tempStartDate);
                                foundValidDayFromStart = true;
                                break;
                            }
                            tempStartDate.setDate(tempStartDate.getDate() + 1);
                        }
                        if (!foundValidDayFromStart) {
                             nextDueDate = new Date(task.startDate); // Fallback to start date if no specific day found immediately
                        }
                    }

                } else if (baseDateForRecurrence) {
                    nextDueDate = new Date(baseDateForRecurrence);
                    if (task.frequencyUnit === 'days') {
                        nextDueDate.setDate(nextDueDate.getDate() + task.frequencyValue);
                    } else if (task.frequencyUnit === 'weeks') {
                        nextDueDate.setDate(nextDueDate.getDate() + (task.frequencyValue * 7));
                    } else if (task.frequencyUnit === 'months') {
                        nextDueDate.setMonth(nextDueDate.getMonth() + task.frequencyValue);
                    } else if (task.frequencyUnit === 'years') {
                        nextDueDate.setFullYear(nextDueDate.getFullYear() + task.frequencyValue);
                    }

                    // If a startDate is present and calculated nextDueDate is before it, use startDate as minimum
                    if (task.startDate) {
                        const actualStartDate = new Date(task.startDate);
                        if (nextDueDate < actualStartDate) {
                            nextDueDate = actualStartDate;
                        }
                    }
                } else {
                    nextDueDate = nowOnly; // If no lastCompleted and no startDate, assume due today
                }
                
                // Compare with the date being rendered in the calendar
                return nextDueDate && dateOnly.toDateString() === new Date(nextDueDate.getFullYear(), nextDueDate.getMonth(), nextDueDate.getDate()).toDateString();
            });
        }

        // Muestra el modal con las tareas de un día específico
        function showDayTasksModal(date, tasks) {
            const dayTasksModal = document.getElementById('dayTasksModal');
            const dayTasksModalTitle = document.getElementById('dayTasksModalTitle');
            const dayTasksModalContent = document.getElementById('dayTasksModalContent');
            
            // Formatear la fecha para el título
            const formattedDate = date.toLocaleDateString('es-ES', { 
                weekday: 'long', 
                year: 'numeric', 
                month: 'long', 
                day: 'numeric' 
            });
            dayTasksModalTitle.textContent = `Tareas para ${formattedDate}`;
            
            // Limpiar el contenido
            dayTasksModalContent.innerHTML = '';
            
            if (tasks.length === 0) {
                dayTasksModalContent.innerHTML = '<li class="text-gray-500 text-center py-4">No hay tareas para este día</li>';
            } else {
                tasks.forEach(task => {
                    const taskItem = document.createElement('li');
                    taskItem.innerHTML = `
                        <div class="flex justify-between items-center">
                            <div>
                                <strong>${task.name}</strong>
                                <div class="task-due text-gray-500">${task.category}</div>
                            </div>
                            <div class="flex space-x-2">
                                <button class="complete-btn bg-green-500 hover:bg-green-600 text-white text-xs px-2 py-1 rounded" data-task-id="${task.id}">
                                    <i class="fas fa-check"></i>
                                </button>
                                <button class="postpone-btn bg-yellow-500 hover:bg-yellow-600 text-white text-xs px-2 py-1 rounded" data-task-id="${task.id}">
                                    <i class="fas fa-forward"></i>
                                </button>
                            </div>
                        </div>
                    `;
                    dayTasksModalContent.appendChild(taskItem);
                });
                
                // Añadir event listeners a los botones de completar y posponer
                document.querySelectorAll('#dayTasksModalContent .complete-btn').forEach(button => {
                    button.addEventListener('click', (e) => {
                        const taskId = e.currentTarget.dataset.taskId;
                        const taskIndex = appData.tasks.findIndex(t => t.id === taskId);
                        if (taskIndex > -1) {
                            appData.tasks[taskIndex].lastCompleted = new Date().toISOString();
                            appData.tasks[taskIndex].isCompleted = true;
                            appData.tasks[taskIndex].postponeUntilDate = null;
                            saveData(appData);
                            renderCalendar();
                            renderAllTasks();
                            dayTasksModal.classList.add('hidden');
                            showMessage('Tarea marcada como completada.', 'success');
                            renderProgress();
                        }
                    });
                });
                
                document.querySelectorAll('#dayTasksModalContent .postpone-btn').forEach(button => {
                    button.addEventListener('click', (e) => {
                        const taskId = e.currentTarget.dataset.taskId;
                        const taskIndex = appData.tasks.findIndex(t => t.id === taskId);
                        if (taskIndex > -1) {
                            const now = new Date();
                            const postponeDate = new Date(now.getTime() + (24 * 60 * 60 * 1000));
                            appData.tasks[taskIndex].postponeUntilDate = postponeDate.toISOString();
                            saveData(appData);
                            renderCalendar();
                            renderAllTasks();
                            dayTasksModal.classList.add('hidden');
                            showMessage('Tarea pospuesta por 1 día.', 'success');
                        }
                    });
                });
            }
            
            dayTasksModal.classList.remove('hidden');
        }

        // Event listeners para los botones de navegación del calendario
        document.getElementById('prevMonthBtn').addEventListener('click', () => {
            currentMonth--;
            if (currentMonth < 0) {
                currentMonth = 11;
                currentYear--;
            }
            renderCalendar();
        });

        document.getElementById('nextMonthBtn').addEventListener('click', () => {
            currentMonth++;
            if (currentMonth > 11) {
                currentMonth = 0;
                currentYear++;
            }
            renderCalendar();
        });

        // Cerrar modal de tareas del día
        document.getElementById('closeDayTasksModalBtn').addEventListener('click', () => {
            document.getElementById('dayTasksModal').classList.add('hidden');
        });

        // --- Gestión del Progreso ---

        // Renderiza la sección de progreso
        function renderProgress() {
            const totalTasksCreated = appData.tasks.length;
            const totalTasksCompleted = appData.tasks.filter(task => task.isCompleted).length;
            const completionPercentage = totalTasksCreated > 0 ? Math.round((totalTasksCompleted / totalTasksCreated) * 100) : 0;
            
            document.getElementById('totalTasksCreated').textContent = totalTasksCreated;
            document.getElementById('totalTasksCompleted').textContent = totalTasksCompleted;
            
            const progressBar = document.getElementById('completionProgressBar');
            progressBar.style.width = `${completionPercentage}%`;
            progressBar.textContent = `${completionPercentage}%`;
            
            // Mensaje motivacional basado en el progreso
            const motivationalMessage = document.getElementById('motivationalMessage');
            if (completionPercentage === 0) {
                motivationalMessage.textContent = '¡Vamos a empezar a organizar tu hogar!';
            } else if (completionPercentage < 25) {
                motivationalMessage.textContent = '¡Buen comienzo! Sigue así.';
            } else if (completionPercentage < 50) {
                motivationalMessage.textContent = '¡Estás avanzando! Cada tarea cuenta.';
            } else if (completionPercentage < 75) {
                motivationalMessage.textContent = '¡Más de la mitad completada! ¡Sigue así!';
            } else if (completionPercentage < 100) {
                motivationalMessage.textContent = '¡Casi terminas! ¡Último esfuerzo!';
            } else {
                motivationalMessage.textContent = '¡Felicidades! Has completado todas tus tareas.';
            }
        }

        // --- Gestión de Pestañas ---

        // Cambia entre pestañas
        function switchTab(tabId) {
            // Ocultar todas las pestañas
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.add('hidden');
            });
            
            // Mostrar la pestaña seleccionada
            document.getElementById(tabId).classList.remove('hidden');
            
            // Actualizar navegación activa
            document.querySelectorAll('.nav-item').forEach(item => {
                item.classList.remove('active-nav-tab');
                const icon = item.querySelector('.nav-icon');
                if (icon) {
                    icon.classList.remove('active');
                }
            });
            
            const activeNavItem = document.querySelector(`.nav-item[data-tab="${tabId}"]`);
            if (activeNavItem) {
                activeNavItem.classList.add('active-nav-tab');
                const activeIcon = activeNavItem.querySelector('.nav-icon');
                if (activeIcon) {
                    activeIcon.classList.add('active');
                }
            }
            
            // Mostrar/ocultar botones flotantes según la pestaña
            if (tabId === 'today' || tabId === 'pending' || tabId === 'history') {
                document.getElementById('addTaskBtn').classList.remove('hidden');
                document.getElementById('addNoteBtn').classList.add('hidden');
            } else if (tabId === 'notes') {
                document.getElementById('addTaskBtn').classList.add('hidden');
                document.getElementById('addNoteBtn').classList.remove('hidden');
            } else {
                document.getElementById('addTaskBtn').classList.add('hidden');
                document.getElementById('addNoteBtn').classList.add('hidden');
            }
            
            // Renderizar contenido específico de la pestaña
            if (tabId === 'calendar') {
                renderCalendar();
            } else if (tabId === 'progress') {
                renderProgress();
            }
        }

        // Event listeners para los botones de navegación
        document.querySelectorAll('.nav-item').forEach(item => {
            item.addEventListener('click', () => {
                const tabId = item.dataset.tab;
                switchTab(tabId);
            });
        });

        // --- Gestión de Modales ---

        // Muestra un modal de confirmación
        function showConfirmModal(message, onConfirm) {
            const confirmModal = document.getElementById('confirmModal');
            const confirmMessage = document.getElementById('confirmMessage');
            const confirmOkBtn = document.getElementById('confirmOkBtn');
            
            confirmMessage.textContent = message;
            confirmModal.classList.remove('hidden');
            
            // Eliminar event listeners anteriores
            const newConfirmOkBtn = confirmOkBtn.cloneNode(true);
            confirmOkBtn.parentNode.replaceChild(newConfirmOkBtn, confirmOkBtn);
            
            // Añadir nuevo event listener
            newConfirmOkBtn.addEventListener('click', () => {
                onConfirm();
                confirmModal.classList.add('hidden');
            });
        }

        // Event listener para el botón de cancelar en el modal de confirmación
        document.getElementById('confirmCancelBtn').addEventListener('click', () => {
            document.getElementById('confirmModal').classList.add('hidden');
        });

        // --- Gestión de Gestos Táctiles ---

        // Variables para el seguimiento de gestos
        let touchStartX = 0;
        let touchEndX = 0;
        let touchStartY = 0;
        let touchEndY = 0;
        let swipeIndicatorTimeout;

        // Mostrar indicador de deslizamiento al cargar la página
        window.addEventListener('load', () => {
            const swipeIndicator = document.getElementById('swipeIndicator');
            swipeIndicator.classList.add('show');
            
            // Ocultar después de 5 segundos
            swipeIndicatorTimeout = setTimeout(() => {
                swipeIndicator.classList.remove('show');
            }, 5000);
        });

        // Event listeners para gestos táctiles
        document.addEventListener('touchstart', e => {
            touchStartX = e.changedTouches[0].screenX;
            touchStartY = e.changedTouches[0].screenY;
        });

        document.addEventListener('touchend', e => {
            touchEndX = e.changedTouches[0].screenX;
            touchEndY = e.changedTouches[0].screenY;
            handleSwipe();
        });

        // Manejar gestos de deslizamiento
        function handleSwipe() {
            // Calcular la distancia del deslizamiento
            const swipeDistanceX = touchEndX - touchStartX;
            const swipeDistanceY = touchEndY - touchStartY;
            
            // Determinar si es un deslizamiento horizontal o vertical
            if (Math.abs(swipeDistanceX) > Math.abs(swipeDistanceY)) {
                // Es un deslizamiento horizontal
                if (Math.abs(swipeDistanceX) > 50) { // Umbral mínimo para considerar un deslizamiento
                    if (swipeDistanceX < 0) {
                        // Deslizar a la izquierda - siguiente pestaña
                        navigateToNextTab();
                    } else {
                        // Deslizar a la derecha - pestaña anterior
                        navigateToPrevTab();
                    }
                    
                    // Ocultar indicador de deslizamiento después del primer uso
                    clearTimeout(swipeIndicatorTimeout);
                    document.getElementById('swipeIndicator').classList.remove('show');
                }
            }
        }

        // Navegar a la siguiente pestaña
        function navigateToNextTab() {
            const activeTab = document.querySelector('.active-nav-tab');
            if (activeTab) {
                const nextTab = activeTab.nextElementSibling;
                if (nextTab && nextTab.classList.contains('nav-item')) {
                    nextTab.click();
                }
            }
        }

        // Navegar a la pestaña anterior
        function navigateToPrevTab() {
            const activeTab = document.querySelector('.active-nav-tab');
            if (activeTab) {
                const prevTab = activeTab.previousElementSibling;
                if (prevTab && prevTab.classList.contains('nav-item')) {
                    prevTab.click();
                }
            }
        }

        // --- Inicialización de la Aplicación ---

        // Inicializar la aplicación cuando el DOM esté cargado
        document.addEventListener('DOMContentLoaded', () => {
            // Renderizar tareas y notas iniciales
            renderAllTasks();
            renderAllNotes();
            renderProgress();
            
            // Establecer la pestaña activa inicial
            switchTab('today');
            
            // Agregar soporte para el modo offline
            window.addEventListener('online', () => {
                showMessage('Conexión a Internet restaurada', 'success');
            });
            
            window.addEventListener('offline', () => {
                showMessage('Sin conexión a Internet. Trabajando en modo offline', 'error');
            });
            
            // Optimizar para dispositivos móviles
            if ('serviceWorker' in navigator) {
                navigator.serviceWorker.register('/service-worker.js')
                    .then(registration => {
                        console.log('Service Worker registrado con éxito:', registration);
                    })
                    .catch(error => {
                        console.log('Error al registrar el Service Worker:', error);
                    });
            }
        });

        // Prevenir el comportamiento predeterminado de ciertos gestos
        document.addEventListener('touchmove', (e) => {
            // Permitir el desplazamiento vertical pero prevenir el desplazamiento horizontal
            if (Math.abs(e.touches[0].clientX - e.touches[0].clientX) > Math.abs(e.touches[0].clientY - e.touches[0].clientY)) {
                e.preventDefault();
            }
        }, { passive: false });
    </script>
</body>
</html>
