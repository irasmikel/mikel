<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1.0" name="viewport"/>
<title>Acceso Seguro</title>
<script src="https://cdn.tailwindcss.com"></script>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&amp;display=swap" rel="stylesheet"/>
<link crossorigin="anonymous" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" referrerpolicy="no-referrer" rel="stylesheet"/>
<style>
  body { 
    font-family: 'Inter', sans-serif; 
    background-color: #f8f9fa; 
  }
  .main-search-container { 
    min-height: calc(100vh - 200px); 
    display: flex; 
    align-items: center; 
    justify-content: center; 
  }
  .note-card { 
    transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out; 
  }
  .note-card:hover { 
    transform: translateY(-5px); 
    box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.07), 0 4px 6px -4px rgb(0 0 0 / 0.07); 
  }
  .modal { 
    display: none; 
    opacity: 0; 
    transition: opacity 0.3s ease; 
  }
  .modal.active { 
    display: flex; 
    opacity: 1; 
  }
  .modal-content { 
    transform: scale(0.95); 
    transition: transform 0.3s ease; 
  }
  .modal.active .modal-content { 
    transform: scale(1); 
  }
  input[type="file"] { 
    display: none; 
  }
  #toast-container { 
    position: fixed; 
    top: 20px; 
    right: 20px; 
    z-index: 1050; /* Aumentado para estar sobre los modales */
  }
  .toast { 
    display: flex; 
    align-items: center; 
    padding: 1rem 1.5rem; 
    border-radius: 0.5rem; 
    box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1); 
    opacity: 0; 
    transform: translateX(100%); 
    transition: all 0.3s ease-in-out; 
  }
  .toast.show { 
    opacity: 1; 
    transform: translateX(0); 
  }
  .toast.success { background-color: #d1fae5; color: #065f46; }
  .toast.error { background-color: #fee2e2; color: #991b1b; }
  .mobile-menu {
    transition: transform 0.3s ease-in-out;
    transform: translateX(100%);
    z-index: 1040;
  }
  .mobile-menu.active {
    transform: translateX(0);
  }
  .dropdown-menu {
    display: none;
  }
  .dropdown-menu.active {
    display: block;
  }
</style>
</head>
<body class="bg-gray-100">

<!-- Pantalla de carga -->
<div class="fixed inset-0 flex items-center justify-center bg-white z-[1060]" id="loader">
  <div class="text-center space-y-4">
    <svg class="animate-spin h-10 w-10 text-blue-600 mx-auto" fill="none" viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
      <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
      <path class="opacity-75" d="M4 12a8 8 0 018-8v8z" fill="currentColor"></path>
    </svg>
    <p class="text-gray-700 text-lg font-medium">Cargando…</p>
  </div>
</div>

<!-- Pantalla de PIN -->
<div class="flex items-center justify-center h-screen" id="pinScreenContainer">
  <div class="text-center space-y-6 p-8" id="pinScreen">
    <h1 class="text-2xl font-bold">Introduce el PIN para acceder</h1>
    <input class="px-4 py-2 border rounded text-center text-xl" id="pinInput" maxlength="4" placeholder="PIN" type="password"/>
    <div>
      <button class="mt-4 bg-blue-600 text-white px-6 py-2 rounded hover:bg-blue-700" onclick="checkPIN()">Entrar</button>
    </div>
    <p class="text-red-500 font-medium hidden" id="errorMsg">PIN incorrecto</p>
  </div>
</div>


<!-- Contenido principal de la aplicación -->
<div id="appContent" style="display: none;">
  <!-- Header -->
  <header class="bg-white/80 backdrop-blur-lg sticky top-0 z-40 border-b border-gray-200" id="app-header">
    <div class="container mx-auto px-4 sm:px-6 lg:px-8">
      <div class="flex items-center justify-between h-16">
        <div class="flex items-center">
          <button class="flex items-center gap-2 text-xl font-bold text-gray-800" id="logoButton">
            <span class="bg-gray-800 text-white rounded-md w-7 h-7 flex items-center justify-center"><i class="fa-solid fa-plus"></i></span> Mikel
          </button>
        </div>
        <!-- Menú de escritorio -->
        <nav class="hidden md:flex items-center gap-3">
          <button class="flex items-center gap-2 px-4 py-2 text-sm font-medium text-gray-700 bg-white border border-gray-300 rounded-md hover:bg-gray-50" id="viewAllButton">
            <i class="fa-solid fa-list"></i> Ver Todo
          </button>
          <button class="flex items-center gap-2 px-4 py-2 text-sm font-medium text-gray-700 bg-white border border-gray-300 rounded-md hover:bg-gray-50" id="mfcButton">
            <i class="fa-solid fa-download"></i> Recursos
          </button>
          <button class="flex items-center gap-2 px-4 py-2 text-sm font-medium text-white bg-gray-800 rounded-md hover:bg-gray-900" id="addItemButtonHeader">
            <i class="fa-solid fa-plus"></i> Añadir Item
          </button>
        </nav>
        <!-- Botón de logout (Escritorio) -->
        <button class="hidden md:block text-gray-700 bg-white p-2 rounded shadow-md hover:bg-gray-100" onclick="logoutApp()">
          <i class="fas fa-sign-out-alt"></i>
        </button>
        <!-- Botón hamburguesa (Móvil) -->
        <button class="md:hidden text-gray-700 text-2xl" id="menuToggleBtn">
          <i class="fas fa-bars"></i>
        </button>
      </div>
    </div>
  </header>

  <!-- Menú lateral para móvil -->
  <div class="fixed top-0 right-0 h-full w-64 bg-white shadow-lg p-6 mobile-menu md:hidden" id="mobileMenu">
      <div class="flex justify-between items-center mb-6">
          <h3 class="text-xl font-bold">Menú</h3>
          <button class="text-gray-700 text-2xl" id="closeMobileMenuBtn"><i class="fas fa-times"></i></button>
      </div>
      <div class="flex flex-col space-y-4">
          <button class="flex items-center gap-2 px-4 py-2 text-gray-700 hover:bg-gray-100 rounded-md" id="mobileViewAllButton">
              <i class="fa-solid fa-list fa-fw"></i> Ver Todo
          </button>
          <button class="flex items-center gap-2 px-4 py-2 text-gray-700 hover:bg-gray-100 rounded-md" id="mobileMfcButton">
              <i class="fa-solid fa-download fa-fw"></i> Recursos
          </button>
          <button class="flex items-center gap-2 px-4 py-2 text-gray-700 hover:bg-gray-100 rounded-md" id="mobileAddItemButton">
              <i class="fa-solid fa-plus fa-fw"></i> Añadir Item
          </button>
          <div class="border-t my-4"></div>
          <button class="flex items-center gap-2 px-4 py-2 text-red-600 hover:bg-red-50 rounded-md" onclick="logoutApp()">
            <i class="fas fa-sign-out-alt fa-fw"></i> Salir
          </button>
      </div>
  </div>

  <!-- Contenido principal -->
  <main class="container mx-auto p-4 sm:p-6 lg:p-8" id="app-main">
    <div id="toast-container"></div>
    <!-- Vista de búsqueda principal -->
    <div id="main-search-view">
      <div class="main-search-container">
        <div class="text-center w-full max-w-2xl px-4">
          <div class="flex justify-center items-center gap-3 mb-6">
            <span class="bg-white border-2 border-gray-200 rounded-2xl w-16 h-16 flex items-center justify-center text-2xl"><i class="fa-solid fa-plus"></i></span>
          </div>
          <h1 class="text-5xl font-bold text-gray-800 mb-8">Mikel</h1>
          <!-- Contenedor de búsqueda rediseñado para ser responsive -->
          <div class="w-full space-y-3">
              <input class="w-full pl-6 pr-4 py-4 border border-gray-200 rounded-full focus:ring-2 focus:ring-blue-500 focus:border-blue-500 shadow-lg" id="mainSearchInput" placeholder="Busca en tus notas o en la red..." type="text"/>
              <div class="flex flex-col sm:flex-row gap-3 justify-center">
                  <button class="w-full sm:w-auto px-6 py-3 bg-gray-800 text-white rounded-full hover:bg-gray-900 transition-colors" id="mainSearchButton">Buscar en Notas</button>
                  <div class="relative w-full sm:w-auto">
                      <button class="w-full flex items-center justify-center gap-2 px-6 py-3 bg-blue-600 text-white rounded-full hover:bg-blue-700 transition-colors" id="webSearchDropdownBtn">
                          Búsqueda Web <i class="fas fa-caret-down"></i>
                      </button>
                      <div class="dropdown-menu absolute right-0 mt-2 py-2 w-48 bg-white rounded-md shadow-xl z-20" id="webSearchDropdownMenu">
                          <a class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100" data-type="copytech" href="#">Copytechnet</a>
                          <a class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100" data-type="printcopy" href="#">Printcopy.info</a>
                          <a class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100" data-type="google" href="#">Google General</a>
                      </div>
                  </div>
              </div>
          </div>
        </div>
      </div>
    </div>
    <!-- Vista de todos los items -->
    <div class="hidden" id="all-items-view">
      <div class="flex flex-col md:flex-row justify-between items-center mb-6 gap-4">
        <h2 class="text-2xl font-bold text-gray-800">Base de Conocimiento</h2>
        <div class="relative w-full md:max-w-xs">
          <input class="w-full pl-10 pr-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500" id="searchInput" placeholder="Filtrar resultados..." type="text"/>
          <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none"><i class="fas fa-search text-gray-400"></i></div>
        </div>
      </div>
      <div class="text-center py-10" id="loading-indicator"><i class="fas fa-spinner fa-spin fa-3x text-blue-500"></i><p class="mt-2 text-gray-600">Cargando items...</p></div>
      <div class="text-center py-10 bg-white rounded-lg shadow-sm hidden" id="no-notes-message"><i class="fas fa-folder-open fa-3x text-gray-400"></i><p class="mt-4 text-xl font-semibold text-gray-700">No hay items todavía.</p><p class="text-gray-500">Usa el botón "Añadir Item" para empezar.</p></div>
      <div class="text-center py-10 bg-white rounded-lg shadow-sm hidden" id="no-results-message"><i class="fas fa-search-minus fa-3x text-gray-400"></i><p class="mt-4 text-xl font-semibold text-gray-700">No se encontraron resultados.</p><p class="text-gray-500">Prueba con otros términos de búsqueda.</p></div>
      <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6" id="notes-container"></div>
    </div>
  </main>
</div>

<!-- Modales -->
<div class="modal fixed inset-0 bg-gray-900 bg-opacity-75 items-center justify-center p-4 z-50 overflow-y-auto" id="addNoteModal">
    <div class="modal-content bg-white rounded-xl shadow-2xl w-full max-w-2xl transform transition-all">
        <div class="flex justify-between items-center p-5 border-b border-gray-200"><h3 class="text-2xl font-bold text-gray-800" id="modalTitle">Añadir Nuevo Item</h3><button class="modal-close text-gray-400 hover:text-gray-600" data-modal="addNoteModal"><i class="fas fa-times fa-2x"></i></button></div>
        <form id="addNoteForm" onsubmit="return false;">
            <input id="noteIdToEdit" type="hidden"/>
            <div class="p-6 space-y-4 max-h-[70vh] overflow-y-auto">
                <div><label class="block text-sm font-medium text-gray-700 mb-1" for="noteTitle">Título</label><input class="w-full border border-gray-300 rounded-lg p-2 focus:ring-2 focus:ring-blue-500" id="noteTitle" type="text"/></div>
                <div><label class="block text-sm font-medium text-gray-700 mb-1" for="noteContent">Contenido</label><textarea class="w-full border border-gray-300 rounded-lg p-2 focus:ring-2 focus:ring-blue-500" id="noteContent" rows="8"></textarea></div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Adjuntos</label>
                    <input id="noteAttachment" type="file" multiple/>
                    <label class="w-full cursor-pointer bg-white border border-gray-300 rounded-lg p-2 flex items-center justify-center gap-2 hover:bg-gray-50" for="noteAttachment"><i class="fas fa-upload"></i><span>Seleccionar archivos</span></label>
                    <div class="w-full bg-gray-100 border border-gray-200 rounded-lg p-2 mt-2" id="selected-files-container">
                        <div id="file-chosen-list" class="space-y-1"></div>
                        <p id="no-files-selected-message" class="text-sm text-gray-500 text-center py-2">No hay archivos seleccionados.</p>
                    </div>
                </div>
            </div>
        </form>
        <div class="bg-gray-50 p-5 flex justify-end rounded-b-xl"><button class="bg-gray-800 text-white font-bold py-2 px-6 rounded-lg hover:bg-gray-900 transition-colors flex items-center gap-2" id="saveNoteButton">Guardar Item</button></div>
    </div>
</div>

<div class="modal fixed inset-0 bg-gray-900 bg-opacity-75 items-center justify-center p-4 z-50 overflow-y-auto" id="mfcModal">
    <div class="modal-content bg-white rounded-xl shadow-2xl w-full max-w-lg transform transition-all">
        <div class="flex justify-between items-center p-5 border-b border-gray-200"><h3 class="text-2xl font-bold text-gray-800">Recursos</h3><button class="modal-close text-gray-400 hover:text-gray-600" data-modal="mfcModal"><i class="fas fa-times fa-2x"></i></button></div>
        <div class="p-6">
            <ul class="space-y-4">
                <li><a class="flex items-center gap-3 text-blue-600 hover:text-blue-800 hover:underline" download href="#"><i class="fas fa-file-archive fa-fw text-lg"></i><span class="font-medium">MFC.msi</span></a></li>
                <li><a class="flex items-center gap-3 text-blue-600 hover:text-blue-800 hover:underline" download href="#"><i class="fas fa-file-code fa-fw text-lg"></i><span class="font-medium">mfc.exe</span></a></li>
                <li><a class="flex items-center gap-3 text-green-600 hover:text-green-800 hover:underline" href="https://mfc.maquelsa.com/mfc3/access.php" rel="noopener noreferrer" target="_blank"><i class="fas fa-external-link-alt fa-fw text-lg"></i><span class="font-medium">Acceso Web 1 (Maquelsa)</span></a></li>
                <li><a class="flex items-center gap-3 text-green-600 hover:text-green-800 hover:underline" href="https://mirror1.infodesain.com/nodeprint/access.php" rel="noopener noreferrer" target="_blank"><i class="fas fa-external-link-alt fa-fw text-lg"></i><span class="font-medium">Acceso Web 2 (Mirror)</span></a></li>
            </ul>
        </div>
    </div>
</div>

<div class="modal fixed inset-0 bg-gray-900 bg-opacity-75 items-center justify-center p-4 z-50" id="confirmationModal">
    <div class="modal-content bg-white rounded-xl shadow-2xl w-full max-w-md transform transition-all">
        <div class="p-6 text-center"><i class="fas fa-exclamation-triangle fa-3x text-yellow-400 mb-4"></i><h3 class="text-xl font-bold text-gray-800">Confirmación Requerida</h3><p class="text-gray-600 my-4" id="confirmationMessage">¿Estás seguro?</p></div>
        <div class="bg-gray-50 p-4 flex justify-center gap-4 rounded-b-xl"><button class="px-6 py-2 text-sm font-medium text-gray-700 bg-white border border-gray-300 rounded-md hover:bg-gray-50" id="cancelButton">Cancelar</button><button class="px-6 py-2 text-sm font-medium text-white bg-red-600 rounded-md hover:bg-red-700" id="confirmButton">Confirmar</button></div>
    </div>
</div>

<script>
    // --- LÓGICA DE ACCESO (PIN) Y NAVEGACIÓN BÁSICA ---
    window.addEventListener("load", () => {
        document.getElementById("loader").style.display = "none";
    });

    function checkPIN() {
        const pin = document.getElementById("pinInput").value;
        if (pin === "2548") {
            document.getElementById("pinScreenContainer").style.display = "none";
            document.getElementById("appContent").style.display = "block";
            initializeApp(); 
        } else {
            const errorMsg = document.getElementById("errorMsg");
            errorMsg.classList.remove("hidden");
            const pinScreen = document.getElementById("pinScreen");
            pinScreen.classList.add('animate-shake');
            setTimeout(() => pinScreen.classList.remove('animate-shake'), 500);
        }
    }

    function logoutApp() {
        // En modo anónimo, recargar la página es la forma más simple de "cerrar sesión"
        window.location.reload();
    }
</script>

<!-- Scripts de Firebase y de la Aplicación -->
<script src="https://www.gstatic.com/firebasejs/10.4.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.4.0/firebase-firestore-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.4.0/firebase-storage-compat.js"></script>
<!-- AÑADIDO: Script de autenticación necesario -->
<script src="https://www.gstatic.com/firebasejs/10.4.0/firebase-auth-compat.js"></script>

<script>
    // --- LÓGICA PRINCIPAL DE LA APLICACIÓN ---

    const firebaseConfig = {
        apiKey: "TU_API_KEY_AQUI",
        authDomain: "TU_AUTH_DOMAIN_AQUI",
        projectId: "mikelaneako",
        storageBucket: "TU_STORAGE_BUCKET_AQUI",
        messagingSenderId: "TU_SENDER_ID_AQUI",
        appId: "TU_APP_ID_AQUI"
    };

    // MODIFICADO: Añadida la variable `auth`
    let db, storage, auth;
    let allNotes = [];
    let DOM = {};
    let currentSelectedFiles = [];

    // MODIFICADO: La función ahora incluye la autenticación anónima
    function initializeApp() {
        if (firebase.apps.length === 0) {
            firebase.initializeApp(firebaseConfig);
            db = firebase.firestore();
            storage = firebase.storage();
            auth = firebase.auth(); // Inicializa el servicio de autenticación
        }
        
        // Inicia sesión de forma anónima para obtener permisos de escritura/lectura
        auth.signInAnonymously()
            .then(() => {
                console.log("Usuario autenticado anónimamente con éxito.");

                // Evita volver a añadir event listeners si la función se llama de nuevo por error
                if (!Object.keys(DOM).length) {
                    initializeDOMElements();
                    setupEventListeners();
                }
                
                // Muestra la aplicación y carga los datos
                DOM.appHeader.classList.remove('hidden');
                DOM.appMain.classList.remove('hidden');
                showView('search');
                loadNotes();
            })
            .catch((error) => {
                console.error("Error al autenticar anónimamente:", error);
                showToast("Fallo de autenticación. No se podrán guardar datos.", "error");
            });
    }
    
    function initializeDOMElements() {
        DOM = {
            appHeader: document.getElementById('app-header'),
            appMain: document.getElementById('app-main'),
            mainSearchView: document.getElementById('main-search-view'),
            allItemsView: document.getElementById('all-items-view'),
            notesContainer: document.getElementById('notes-container'),
            searchInput: document.getElementById('searchInput'),
            mainSearchInput: document.getElementById('mainSearchInput'),
            mainSearchButton: document.getElementById('mainSearchButton'),
            loadingIndicator: document.getElementById('loading-indicator'),
            noNotesMessage: document.getElementById('no-notes-message'),
            noResultsMessage: document.getElementById('no-results-message'),
            logoButton: document.getElementById('logoButton'),
            viewAllButton: document.getElementById('viewAllButton'),
            mfcButton: document.getElementById('mfcButton'),
            mfcModal: document.getElementById('mfcModal'),
            addItemButtonHeader: document.getElementById('addItemButtonHeader'),
            addNoteModal: document.getElementById('addNoteModal'),
            addNoteForm: document.getElementById('addNoteForm'),
            modalTitle: document.getElementById('modalTitle'),
            noteIdToEdit: document.getElementById('noteIdToEdit'),
            noteTitleInput: document.getElementById('noteTitle'),
            noteContentInput: document.getElementById('noteContent'),
            noteAttachmentInput: document.getElementById('noteAttachment'),
            fileChosenList: document.getElementById('file-chosen-list'),
            noFilesSelectedMessage: document.getElementById('no-files-selected-message'),
            saveNoteButton: document.getElementById('saveNoteButton'),
            confirmationModal: document.getElementById('confirmationModal'),
            confirmationMessage: document.getElementById('confirmationMessage'),
            confirmButton: document.getElementById('confirmButton'),
            cancelButton: document.getElementById('cancelButton'),
            toastContainer: document.getElementById('toast-container'),
            webSearchDropdownBtn: document.getElementById('webSearchDropdownBtn'),
            webSearchDropdownMenu: document.getElementById('webSearchDropdownMenu'),
            menuToggleBtn: document.getElementById('menuToggleBtn'),
            mobileMenu: document.getElementById('mobileMenu'),
            closeMobileMenuBtn: document.getElementById('closeMobileMenuBtn'),
            mobileViewAllButton: document.getElementById('mobileViewAllButton'),
            mobileAddItemButton: document.getElementById('mobileAddItemButton'),
            mobileMfcButton: document.getElementById('mobileMfcButton')
        };
    }

    function setupEventListeners() {
        DOM.logoButton.addEventListener('click', () => showView('search'));
        DOM.viewAllButton.addEventListener('click', () => { DOM.searchInput.value = ''; renderNotes(allNotes); showView('items'); });
        DOM.mfcButton.addEventListener('click', () => toggleModal('mfcModal', true));
        DOM.mainSearchButton.addEventListener('click', () => performSearch(DOM.mainSearchInput.value, 'db'));
        DOM.mainSearchInput.addEventListener('keypress', (e) => { if (e.key === 'Enter') performSearch(DOM.mainSearchInput.value, 'db'); });
        DOM.searchInput.addEventListener('input', () => filterNotes(DOM.searchInput.value));
        DOM.addItemButtonHeader.addEventListener('click', () => openAddModal());
        document.querySelectorAll('.modal-close').forEach(btn => btn.addEventListener('click', () => toggleModal(btn.dataset.modal, false)));
        DOM.saveNoteButton.addEventListener('click', saveNote);
        DOM.noteAttachmentInput.addEventListener('change', handleFileSelect);
        DOM.cancelButton.addEventListener('click', () => toggleModal('confirmationModal', false));

        DOM.webSearchDropdownBtn.addEventListener('click', (e) => {
            e.stopPropagation();
            DOM.webSearchDropdownMenu.classList.toggle('active');
        });
        document.addEventListener('click', () => DOM.webSearchDropdownMenu.classList.remove('active'));
        DOM.webSearchDropdownMenu.addEventListener('click', (e) => {
            if(e.target.tagName === 'A') {
                performSearch(DOM.mainSearchInput.value, e.target.dataset.type);
                DOM.webSearchDropdownMenu.classList.remove('active');
            }
        });

        DOM.menuToggleBtn.addEventListener('click', () => DOM.mobileMenu.classList.add('active'));
        DOM.closeMobileMenuBtn.addEventListener('click', () => DOM.mobileMenu.classList.remove('active'));
        
        const closeMobileMenu = () => DOM.mobileMenu.classList.remove('active');
        DOM.mobileViewAllButton.addEventListener('click', () => { DOM.viewAllButton.click(); closeMobileMenu(); });
        DOM.mobileAddItemButton.addEventListener('click', () => { openAddModal(); closeMobileMenu(); });
        DOM.mobileMfcButton.addEventListener('click', () => { toggleModal('mfcModal', true); closeMobileMenu(); });
    }

    // --- MANEJO DE VISTAS Y MODALES ---
    function showView(viewName) {
        DOM.mainSearchView.classList.toggle('hidden', viewName !== 'search');
        DOM.allItemsView.classList.toggle('hidden', viewName !== 'items');
        window.scrollTo(0, 0);
    }

    function toggleModal(modalId, show) {
        const modal = document.getElementById(modalId);
        if (modal) {
            if (show) modal.classList.add('active');
            else modal.classList.remove('active');
            if (!show && modalId === 'addNoteModal') resetAddNoteForm();
        }
    }

    // --- LÓGICA DE BÚSQUEDA ---
    function performSearch(searchTerm, type) {
        if (!searchTerm.trim()) {
            showToast("Introduce un término de búsqueda.", "error");
            return;
        }
        if (type === 'db') {
            filterNotes(searchTerm);
            showView('items');
        } else {
            let searchUrl;
            if (type === 'copytech') {
                searchUrl = `https://www.google.com/search?q=${encodeURIComponent(searchTerm)}+site:copytechnet.com`;
            } else if (type === 'printcopy') {
                searchUrl = `https://www.google.com/search?q=${encodeURIComponent(searchTerm)}+site:printcopy.info`;
            } else { 
                searchUrl = `https://www.google.com/search?q=${encodeURIComponent(searchTerm)}`;
            }
            window.open(searchUrl, '_blank');
        }
    }
    
    // --- LÓGICA DE GESTIÓN DE NOTAS (CRUD) ---
    function openAddModal() {
        resetAddNoteForm();
        DOM.modalTitle.textContent = "Añadir Nuevo Item";
        toggleModal('addNoteModal', true);
    }

    function openEditModal(note) {
        resetAddNoteForm();
        DOM.modalTitle.textContent = "Editar Item";
        DOM.noteIdToEdit.value = note.id;
        DOM.noteTitleInput.value = note.titulo;
        DOM.noteContentInput.value = note.descripcion;

        if (note.attachments && note.attachments.length > 0) {
            currentSelectedFiles = note.attachments.map(att => ({ ...att, isExisting: true }));
            renderSelectedFiles();
        }
        toggleModal('addNoteModal', true);
    }

    function resetAddNoteForm() {
        DOM.addNoteForm.reset();
        DOM.noteIdToEdit.value = '';
        clearSelectedFiles();
    }
    
    async function saveNote() {
        const title = DOM.noteTitleInput.value.trim();
        const content = DOM.noteContentInput.value.trim();
        const noteId = DOM.noteIdToEdit.value;

        if (!title || !content) {
            showToast('El título y el contenido son obligatorios.', 'error');
            return;
        }

        DOM.saveNoteButton.disabled = true;
        DOM.saveNoteButton.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Guardando...';

        try {
            let finalAttachments = [];
            const newFilesToUpload = currentSelectedFiles.filter(file => !file.isExisting);
            const uploadedNewAttachments = await uploadFiles(newFilesToUpload);
            
            if (noteId) { // Editando
                const existingNote = allNotes.find(n => n.id === noteId);
                const attachmentsToKeep = currentSelectedFiles.filter(file => file.isExisting);
                
                const oldAttachments = existingNote.attachments || [];
                const filesToDelete = oldAttachments.filter(oldAtt => 
                    !attachmentsToKeep.some(keepAtt => keepAtt.path === oldAtt.path)
                );
                for (const file of filesToDelete) {
                    if (file.path) await storage.ref(file.path).delete().catch(console.warn);
                }
                
                finalAttachments = [...attachmentsToKeep, ...uploadedNewAttachments];
            } else { // Creando
                finalAttachments = uploadedNewAttachments;
            }

            const noteData = { 
                titulo: title,
                descripcion: content,
                attachments: finalAttachments,
                fecha: firebase.firestore.Timestamp.fromDate(new Date())
            };

            if (noteId) {
                await db.collection("notas").doc(noteId).update(noteData);
                showToast("Item actualizado.", "success");
            } else {
                await db.collection("notas").add(noteData);
                showToast("Item añadido.", "success");
            }
            toggleModal('addNoteModal', false);
        } catch (error) {
            console.error("Error al guardar el item:", error);
            showToast("No se pudo guardar el item. Revisa las reglas de seguridad de Firebase.", "error");
        } finally {
            DOM.saveNoteButton.disabled = false;
            DOM.saveNoteButton.innerHTML = 'Guardar Item';
        }
    }
    
    async function deleteNote(noteId) {
        try {
            const noteRef = db.collection("notas").doc(noteId);
            const noteDoc = await noteRef.get();
            if (noteDoc.exists) {
                const noteData = noteDoc.data();
                if (noteData.attachments && noteData.attachments.length > 0) {
                    for (const attachment of noteData.attachments) {
                        if (attachment.path) await storage.ref(attachment.path).delete().catch(console.warn);
                    }
                }
            }
            await noteRef.delete();
            showToast("Item eliminado.", "success");
        } catch (error) {
            console.error("Error al eliminar el item: ", error);
            showToast('No se pudo eliminar el item.', 'error');
        }
    }

    function loadNotes() {
        DOM.loadingIndicator.classList.remove('hidden');
        db.collection("notas").orderBy("fecha", "desc").onSnapshot((snapshot) => {
            allNotes = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            renderNotes(allNotes); 
            DOM.loadingIndicator.classList.add('hidden');
        }, (error) => {
            console.error("Error al cargar los items: ", error);
            showToast("Error al cargar los items.", "error");
            DOM.loadingIndicator.classList.add('hidden');
        });
    }

    // --- MANEJO DE ADJUNTOS ---
    function handleFileSelect(e) {
        const newFiles = Array.from(e.target.files);
        const uniqueNewFiles = newFiles.filter(newFile =>
            !currentSelectedFiles.some(existingFile =>
                existingFile.name === newFile.name && existingFile.size === newFile.size
            )
        );
        currentSelectedFiles.push(...uniqueNewFiles);
        renderSelectedFiles();
        e.target.value = ''; 
    }

    function renderSelectedFiles() {
        DOM.fileChosenList.innerHTML = '';
        DOM.noFilesSelectedMessage.classList.toggle('hidden', currentSelectedFiles.length > 0);
        currentSelectedFiles.forEach((file, index) => {
            const fileItem = document.createElement('div');
            fileItem.className = 'flex items-center justify-between bg-white border border-gray-200 rounded-md p-2 text-sm text-gray-700';
            fileItem.innerHTML = `
                <span class="truncate pr-2">${escapeHTML(file.name)}</span>
                <button type="button" class="text-red-500 hover:text-red-700 ml-2 flex-shrink-0" data-index="${index}">
                    <i class="fas fa-times"></i>
                </button>
            `;
            fileItem.querySelector('button').addEventListener('click', () => removeIndividualFile(index));
            DOM.fileChosenList.appendChild(fileItem);
        });
    }

    function removeIndividualFile(index) {
        currentSelectedFiles.splice(index, 1);
        renderSelectedFiles();
    }

    function clearSelectedFiles() {
        DOM.noteAttachmentInput.value = '';
        currentSelectedFiles = [];
        renderSelectedFiles();
    }
    
    async function uploadFiles(files) {
        const uploadPromises = files.map(async (file) => {
            const storageRef = storage.ref(`adjuntos/${Date.now()}-${file.name}`);
            await storageRef.put(file);
            const url = await storageRef.getDownloadURL();
            return { url, path: storageRef.fullPath, name: file.name };
        });
        return await Promise.all(uploadPromises);
    }
    
    // --- RENDERIZADO Y FILTRADO ---
    function renderNotes(notes) {
        DOM.notesContainer.innerHTML = '';
        DOM.noNotesMessage.classList.toggle('hidden', allNotes.length > 0);
        DOM.noResultsMessage.classList.toggle('hidden', notes.length > 0 || allNotes.length === 0);

        notes.forEach(note => {
            const noteElement = document.createElement('div');
            noteElement.className = 'note-card bg-white p-6 rounded-xl shadow-sm border border-gray-200 flex flex-col justify-between';
            
            const attachmentsHTML = (note.attachments && note.attachments.length > 0)
                ? `<div class="mt-4 space-y-2">` + note.attachments.map(att => `
                    <a href="${att.url}" target="_blank" rel="noopener noreferrer" class="flex items-center gap-2 text-sm text-blue-600 hover:underline">
                        <i class="fas fa-paperclip fa-fw"></i><span class="truncate">${escapeHTML(att.name || 'Adjunto')}</span>
                    </a>`).join('') + `</div>`
                : '';

            const date = note.fecha ? new Date(note.fecha.seconds * 1000).toLocaleString('es-ES') : 'N/A';
            
            noteElement.innerHTML = `
                <div>
                    <div class="flex justify-between items-start gap-4">
                        <h3 class="text-xl font-bold text-gray-900 flex-grow break-words">${escapeHTML(note.titulo)}</h3>
                        <div class="flex items-center gap-3 flex-shrink-0">
                            <button data-id="${note.id}" class="edit-note-btn text-gray-400 hover:text-blue-500"><i class="fas fa-pencil-alt"></i></button>
                            <button data-id="${note.id}" class="delete-note-btn text-gray-400 hover:text-red-500"><i class="fas fa-trash-alt"></i></button>
                        </div>
                    </div>
                    <p class="text-gray-600 whitespace-pre-wrap mt-2 mb-4 break-words">${escapeHTML(note.descripcion)}</p>
                </div>
                <div class="mt-auto">
                    ${attachmentsHTML}
                    <div class="text-right text-xs text-gray-400 mt-4">${date}</div>
                </div>`;
            
            DOM.notesContainer.appendChild(noteElement);
        });

        DOM.notesContainer.querySelectorAll('.delete-note-btn').forEach(b => b.addEventListener('click', (e) => confirmDelete(e.currentTarget.dataset.id)));
        DOM.notesContainer.querySelectorAll('.edit-note-btn').forEach(b => b.addEventListener('click', (e) => {
            const noteToEdit = allNotes.find(n => n.id === e.currentTarget.dataset.id);
            if(noteToEdit) openEditModal(noteToEdit);
        }));
    }

    function filterNotes(searchTerm) {
        const term = searchTerm.toLowerCase().trim();
        DOM.searchInput.value = term;
        DOM.mainSearchInput.value = term;
        const filtered = allNotes.filter(n => 
            n.titulo.toLowerCase().includes(term) || 
            n.descripcion.toLowerCase().includes(term) || 
            (n.attachments && n.attachments.some(att => att.name.toLowerCase().includes(term)))
        );
        renderNotes(filtered);
    }
    
    // --- UTILIDADES ---
    function escapeHTML(str) { 
        return str.replace(/[&<>"']/g, match => ({'&': '&amp;','<': '&lt;','>': '&gt;','"': '&quot;',"'": '&#39;'})[match]);
    }

    function confirmDelete(noteId) {
        showConfirmationModal("¿Seguro que quieres eliminar este item y todos sus adjuntos? Esta acción no se puede deshacer.", () => deleteNote(noteId));
    }

    function showConfirmationModal(message, onConfirmCallback) {
        DOM.confirmationMessage.textContent = message;
        const newConfirmButton = DOM.confirmButton.cloneNode(true);
        DOM.confirmButton.parentNode.replaceChild(newConfirmButton, DOM.confirmButton);
        DOM.confirmButton = newConfirmButton;
        DOM.confirmButton.addEventListener('click', () => { 
            toggleModal('confirmationModal', false); 
            onConfirmCallback(); 
        });
        toggleModal('confirmationModal', true);
    }

    function showToast(message, type = 'success') {
        const toast = document.createElement('div');
        toast.className = `toast ${type}`;
        toast.innerHTML = `<i class="fas ${type === 'success' ? 'fa-check-circle' : 'fa-exclamation-triangle'} mr-3"></i> ${message}`;
        DOM.toastContainer.appendChild(toast);
        setTimeout(() => toast.classList.add('show'), 10);
        setTimeout(() => {
            toast.classList.remove('show');
            toast.addEventListener('transitionend', () => toast.remove());
        }, 4000);
    }
</script>
</body>
</html>